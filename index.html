<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Voxel Pocket - Multiplayer Edition</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');

        body { margin: 0; overflow: hidden; background: #000; touch-action: none; user-select: none; font-family: 'Press Start 2P', cursive; }
        #ui { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
        
        #crosshair {
            position: absolute; top: 50%; left: 50%; width: 20px; height: 20px;
            transform: translate(-50%, -50%); display: flex; align-items: center; justify-content: center;
        }
        #crosshair::before { content: ''; position: absolute; width: 16px; height: 2px; background: rgba(255,255,255,0.8); mix-blend-mode: difference; }
        #crosshair::after { content: ''; position: absolute; width: 2px; height: 16px; background: rgba(255,255,255,0.8); mix-blend-mode: difference; }

        #break-progress {
            position: absolute; top: 50%; left: 50%; width: 40px; height: 40px;
            border: 4px solid rgba(0,0,0,0.5); border-top-color: #fff; border-radius: 50%;
            transform: translate(-50%, -50%) scale(0);
            z-index: 10; transition: transform 0.1s linear;
        }

        .corner-btn {
            position: absolute; top: 10px; width: 36px; height: 36px;
            background: rgba(0,0,0,0.5); border: 2px solid #fff; color: #fff;
            display: flex; align-items: center; justify-content: center;
            font-size: 7px; cursor: pointer; pointer-events: auto;
            box-shadow: 0 3px 0 rgba(0,0,0,0.3); z-index: 100;
        }
        #pause-btn { left: 10px; }
        #chat-toggle-btn { left: 52px; }
        #fs-btn { right: 52px; } 
        #cam-btn { right: 10px; }
        #shop-btn { top: 52px; left: 10px; width: 78px; font-size: 8px; background: #DAA520; color: #000; }
        
        .corner-btn:active { transform: translateY(2px); box-shadow: none; }

        #coin-display {
            position: absolute; top: 10px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.6); border: 2px solid #DAA520; color: #FFD700;
            padding: 8px 15px; font-size: 10px; z-index: 90; text-shadow: 1px 1px #000;
        }

        #hotbar-container {
            position: absolute; bottom: 8px; left: 50%; transform: translateX(-50%);
            display: flex; gap: 2px; background: rgba(0,0,0,0.4); padding: 2px; border: 3px solid #111; pointer-events: auto;
            max-width: 95vw; overflow-x: auto;
        }
        .slot {
            width: 34px; height: 34px; border: 3px solid #555; background: #8B8B8B;
            display: flex; justify-content: center; align-items: center; cursor: pointer; position: relative;
            box-shadow: inset 2px 2px #AAA, inset -2px -2px #333; flex-shrink: 0;
        }
        .slot.active { border-color: #FFF; background: #AAA; z-index: 2; transform: scale(1.05); box-shadow: 0 0 8px white; }
        .slot canvas { width: 24px; height: 24px; image-rendering: pixelated; pointer-events: none; }
        .slot-count { position: absolute; bottom: 2px; right: 2px; font-size: 8px; color: #fff; text-shadow: 1px 1px #000; pointer-events: none; }
        
        #inv-btn {
            width: 34px; height: 34px; background: #8B8B8B; border: 3px solid #111; color: #fff;
            display: flex; align-items: center; justify-content: center; font-size: 7px;
            margin-right: 3px; cursor: pointer; text-shadow: 1px 1px #000;
            box-shadow: inset 2px 2px #AAA, inset -2px -2px #333; flex-shrink: 0;
        }

        .ctrl { position: absolute; pointer-events: auto; z-index: 50; display: none; }
        #joy-zone { bottom: 20px; left: 15px; width: 110px; height: 110px; background: rgba(255,255,255,0.1); border: 2px solid rgba(255,255,255,0.2); border-radius: 50%; }
        #joy-nub { position: absolute; top: 50%; left: 50%; width: 40px; height: 40px; background: #fff; border-radius: 50%; transform: translate(-50%, -50%); opacity: 0.4; pointer-events: none; }
        
        #flight-controls {
            position: absolute; bottom: 20px; right: 15px;
            display: flex; flex-direction: column; gap: 8px; align-items: center;
        }
        .action-btn {
            width: 50px; height: 50px; border-radius: 50%;
            background: rgba(0,0,0,0.3); border: 2px solid rgba(255,255,255,0.4);
            display: flex; align-items: center; justify-content: center;
            backdrop-filter: blur(2px);
        }
        .action-btn svg { width: 24px; height: 24px; fill: white; opacity: 0.8; }

        #chat-container {
            position: fixed; top: 95px; left: 10px; width: 240px; height: 140px;
            display: none; flex-direction: column; z-index: 2500; pointer-events: auto;
        }
        #chat-header { background: rgba(0,0,0,0.8); color: #0f0; padding: 4px; font-size: 6px; border-bottom: 2px solid #333; }
        #chat-log { flex-grow: 1; background: rgba(0,0,0,0.6); color: #fff; padding: 6px; font-size: 7px; overflow-y: auto; display: flex; flex-direction: column-reverse; }
        #chat-input-wrapper { display: flex; background: rgba(0,0,0,0.8); border: 2px solid #555; }
        #chat-input { flex-grow: 1; background: transparent; border: none; color: #fff; padding: 8px; font-family: 'Press Start 2P'; font-size: 7px; outline: none; width: 50%; }
        #chat-send-btn { background: #555; color: #fff; border: none; padding: 0 8px; cursor: pointer; font-family: 'Press Start 2P'; font-size: 7px; }

        #inventory-overlay, #shop-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 2000; pointer-events: auto; }
        #inventory-grid, #shop-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 4px; background: #8B8B8B; padding: 15px; border: 4px solid #111; max-height: 70vh; overflow-y: auto; }
        
        #pause-menu { position: fixed; inset: 0; background: rgba(0,0,0,0.85); display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 3000; pointer-events: auto; }
        .menu-card { background: #8B8B8B; padding: 20px; border: 4px solid #000; display: flex; flex-direction: column; gap: 10px; width: 200px; }
        .menu-btn { padding: 12px; background: #777; color: #fff; border: 3px solid #000; font-family: 'Press Start 2P'; font-size: 9px; cursor: pointer; text-align: center; }

        #loading { position: fixed; inset: 0; background: #111; color: #fff; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 1000; }
        #start-btn { padding: 12px 30px; font-family: 'Press Start 2P'; font-size: 12px; cursor: pointer; background: #777; color: #fff; border: 4px solid #000; margin-top: 15px; display: none;}
        
        #del-mode-btn { background: #a33; margin-top: 5px; width: 100%; font-size: 8px; padding: 8px; border: 2px solid #000; color: white; cursor: pointer; }
        
        #shop-mode-btn { background: #2ecc71; margin-bottom: 5px; width: 100%; font-size: 8px; padding: 8px; border: 2px solid #000; color: white; cursor: pointer; text-align: center; }
        
        .shop-item { width: 50px; height: 60px; background: #555; border: 2px solid #000; display: flex; flex-direction: column; align-items: center; justify-content: space-between; cursor: pointer; padding: 2px; }
        .shop-item:hover { background: #666; }
        .shop-price { font-size: 6px; color: #FFD700; margin-bottom: 2px; text-align: center; }
        .shop-name { font-size: 5px; color: #fff; margin-top: 2px; text-align: center; width: 100%; white-space: nowrap; overflow: hidden; }
        .shop-tabs { display: flex; gap: 5px; margin-bottom: 10px; }
        .shop-tab { padding: 8px; background: #555; color: white; border: 2px solid #000; font-size: 8px; cursor: pointer; }
        .shop-tab.active { background: #DAA520; color: black; }
        .shop-item canvas { image-rendering: pixelated; margin: 2px 0; }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/utils/SkeletonUtils.js"></script>
</head>
<body>
    <div id="loading">
        <h1 style="font-size: 18px; text-shadow: 3px 3px #555; text-align: center;">VOXEL POCKET</h1>
        <p id="loading-text" style="font-size: 7px; color: #aaa; margin-top: 10px;">INITIALIZING...</p>
        <button id="start-btn">ENTER WORLD (GOOGLE LOGIN)</button>
    </div>

    <div id="ui">
        <div id="coin-display">COINS: 0</div>
        <div id="crosshair"></div>
        <div id="break-progress"></div>
        
        <div id="pause-btn" class="corner-btn ctrl">||</div>
        <div id="chat-toggle-btn" class="corner-btn ctrl">MSG</div>
        <div id="fs-btn" class="corner-btn ctrl">FULL</div>
        <div id="cam-btn" class="corner-btn ctrl">POV</div>
        <div id="shop-btn" class="corner-btn ctrl">SHOP</div>

        <div id="chat-container">
            <div id="chat-header">ID: <span id="user-display-id">...</span></div>
            <div id="chat-log"></div>
            <div id="chat-input-wrapper">
                <input type="text" id="chat-input" placeholder="..." maxlength="50">
                <button id="chat-send-btn">></button>
            </div>
        </div>

        <div id="hotbar-container">
            <div id="inv-btn">INV</div>
            <div id="hotbar-slots" style="display: flex; gap: 2px;"></div>
        </div>
        <div id="joy-zone" class="ctrl"><div id="joy-nub"></div></div>
        
        <div id="flight-controls" class="ctrl">
            <div id="up-btn" class="action-btn" style="display: none;">
                <svg viewBox="0 0 24 24"><path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"/></svg>
            </div>
            <div id="jump-btn" class="action-btn">
                <svg viewBox="0 0 24 24"><path d="M12 2L4.5 20.29l.71.71L12 18l6.79 3 .71-.71z"/></svg>
            </div>
            <div id="down-btn" class="action-btn" style="display: none;">
                <svg viewBox="0 0 24 24"><path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6z"/></svg>
            </div>
        </div>
    </div>

    <div id="pause-menu">
        <div class="menu-card">
            <div style="text-align: center; margin-bottom: 5px; color: #fff; text-shadow: 2px 2px #000; font-size: 10px;">PAUSED</div>
            <div id="resume-btn" class="menu-btn">RESUME</div>
            <div id="quit-btn" class="menu-btn" style="background: #a33;">QUIT</div>
        </div>
    </div>

    <div id="inventory-overlay">
        <div style="color: white; margin-bottom: 10px; font-size: 10px;">INVENTORY</div>
        <div id="inventory-grid"></div>
        <button id="del-mode-btn">DELETE MODE: OFF</button>
        <button id="close-inv" class="menu-btn" style="margin-top: 15px; width: 160px;">CLOSE</button>
    </div>

    <div id="shop-overlay">
        <div style="color: #DAA520; margin-bottom: 5px; font-size: 10px;">ITEM SHOP</div>
        <div id="shop-mode-btn">MODE: BUY</div>
        <div style="color: #888; margin-bottom: 10px; font-size: 6px;">L-CLICK: BUY | R-CLICK: SELL</div>
        <div class="shop-tabs">
            <div class="shop-tab active" onclick="switchShopTab('blocks')">BLOCKS</div>
            <div class="shop-tab" onclick="switchShopTab('tools')">TOOLS</div>
            <div class="shop-tab" onclick="switchShopTab('skins')">SKINS</div>
        </div>
        <div id="shop-grid"></div>
        <button id="close-shop" class="menu-btn" style="margin-top: 15px; width: 160px;">CLOSE</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, browserLocalPersistence, setPersistence } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, limit, setDoc, doc, serverTimestamp, deleteDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBgQaeWlxecgunDZo8xHBorRVIrZ8K4YJ8",
            authDomain: "pixelbox-bca1b.firebaseapp.com",
            projectId: "pixelbox-bca1b",
            storageBucket: "pixelbox-bca1b.firebasestorage.app",
            messagingSenderId: "709778027442",
            appId: "1:709778027442:web:c2959397d3285e1f24eaab",
            measurementId: "G-8B9GQFDVY1"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const APP_ID = 'pixelbox_v1'; 

        const CHUNK_SIZE = 16;
        const RENDER_DIST = 3;
        const PLAYER_HEIGHT = 1.62;
        const PLAYER_RADIUS = 0.3;
        const DAY_LENGTH_SECONDS = 300; 
        
        let currentMineDelay = 400; 
        const MOVE_THRESHOLD = 15;

        let currentUser = null;
        let userId = 'Guest';
        let userDisplayName = 'Guest';
        let otherPlayers = {}; 
        let ATLAS_COLS = 8;
        let ATLAS_ROWS = 8;
        
        let coins = 0;
        let inventory = new Array(30).fill(null); 
        let deleteMode = false;
        let shopSellMode = false;
        let landClaims = {}; 
        let currentSkin = 'default';
        let activeTool = null;

        const TOOLS = {
            1001: { name: 'Wood Pick', tier: 1, price: 50, speedMod: 0.7, icon: 'wood_pick.png' },
            1002: { name: 'Stone Pick', tier: 2, price: 150, speedMod: 0.5, icon: 'stone_pick.png' },
            1003: { name: 'Iron Pick', tier: 3, price: 500, speedMod: 0.3, icon: 'iron_pick.png' },
            1004: { name: 'Diamond Pick', tier: 4, price: 1000, speedMod: 0.1, icon: 'diamond_pick.png' }
        };

        const SKINS = {
            'default': { name: 'Robot', price: 0, file: 'RobotExpressive.glb' },
            'blue': { name: 'Blue Bot', price: 200, file: 'RobotExpressive.glb', color: 0x0000ff },
            'red': { name: 'Red Bot', price: 200, file: 'RobotExpressive.glb', color: 0xff0000 },
            'gold': { name: 'Gold Bot', price: 1000, file: 'RobotExpressive.glb', color: 0xFFD700 }
        };

        const BLOCKS = {
            1: { name: 'Grass', price: 4, sellPrice: 1, files: ['grass_side.png', 'grass_side.png', 'grass_top.png', 'dirt.png', 'grass_side.png', 'grass_side.png'], hardness: 0.6 },
            2: { name: 'Dirt', price: 2, sellPrice: 1, files: ['dirt.png', 'dirt.png', 'dirt.png', 'dirt.png', 'dirt.png', 'dirt.png'], hardness: 0.5 },
            3: { name: 'Stone', price: 5, sellPrice: 2, files: ['stone.png', 'stone.png', 'stone.png', 'stone.png', 'stone.png', 'stone.png'], hardness: 1.5 },
            4: { name: 'Log', price: 5, sellPrice: 2, files: ['log_side.png', 'log_side.png', 'log_top.png', 'log_top.png', 'log_side.png', 'log_side.png'], hardness: 2.0 },
            5: { name: 'Leaves', price: 2, sellPrice: 1, files: ['leaves.png', 'leaves.png', 'leaves.png', 'leaves.png', 'leaves.png', 'leaves.png'], transparent: true, hardness: 0.2 },
            6: { name: 'Sand', price: 2, sellPrice: 1, files: ['sand.png', 'sand.png', 'sand.png', 'sand.png', 'sand.png', 'sand.png'], hardness: 0.5 },
            7: { name: 'Planks', price: 4, sellPrice: 1, files: ['planks.png', 'planks.png', 'planks.png', 'planks.png', 'planks.png', 'planks.png'], hardness: 2.0 },
            8: { name: 'Glass', price: 6, sellPrice: 2, files: ['glass.png', 'glass.png', 'glass.png', 'glass.png', 'glass.png', 'glass.png'], transparent: true, hardness: 0.3 },
            9: { name: 'Bedrock', files: ['bedrock.png', 'bedrock.png', 'bedrock.png', 'bedrock.png', 'bedrock.png', 'bedrock.png'], indestructible: true },
            10: { name: 'Torch', price: 5, sellPrice: 1, files: ['torch.png', 'torch.png', 'torch.png', 'torch.png', 'torch.png', 'torch.png'], isTorch: true, light: 0xFFA500, transparent: true, hardness: 0.1 },
            11: { name: 'Water', files: ['water.png', 'water.png', 'water.png', 'water.png', 'water.png', 'water.png'], transparent: true, isFluid: true, opacity: 0.7 },
            12: { name: 'Coal Ore', price: 10, sellPrice: 3, files: ['coal_ore.png', 'coal_ore.png', 'coal_ore.png', 'coal_ore.png', 'coal_ore.png', 'coal_ore.png'], hardness: 3.0 },
            13: { name: 'Iron Ore', price: 15, sellPrice: 4, files: ['iron_ore.png', 'iron_ore.png', 'iron_ore.png', 'iron_ore.png', 'iron_ore.png', 'iron_ore.png'], hardness: 3.0 },
            14: { name: 'Gold Ore', price: 20, sellPrice: 5, files: ['gold_ore.png', 'gold_ore.png', 'gold_ore.png', 'gold_ore.png', 'gold_ore.png', 'gold_ore.png'], hardness: 3.0 },
            15: { name: 'Diamond Ore', price: 30, sellPrice: 6, files: ['diamond_ore.png', 'diamond_ore.png', 'diamond_ore.png', 'diamond_ore.png', 'diamond_ore.png', 'diamond_ore.png'], hardness: 4.0 },
            16: { name: 'Emerald Ore', price: 30, sellPrice: 8, files: ['emerald_ore.png', 'emerald_ore.png', 'emerald_ore.png', 'emerald_ore.png', 'emerald_ore.png', 'emerald_ore.png'], hardness: 3.0 },
            17: { name: 'Cobblestone', price: 3, sellPrice: 1, files: ['cobblestone.png', 'cobblestone.png', 'cobblestone.png', 'cobblestone.png', 'cobblestone.png', 'cobblestone.png'], hardness: 2.0 },
            18: { name: 'Mossy Cobble', price: 4, sellPrice: 1, files: ['mossy_cobblestone.png', 'mossy_cobblestone.png', 'mossy_cobblestone.png', 'mossy_cobblestone.png', 'mossy_cobblestone.png', 'mossy_cobblestone.png'], hardness: 2.0 },
            19: { name: 'Stone Bricks', price: 4, sellPrice: 1, files: ['stone_bricks.png', 'stone_bricks.png', 'stone_bricks.png', 'stone_bricks.png', 'stone_bricks.png', 'stone_bricks.png'], hardness: 1.5 },
            20: { name: 'Obsidian', price: 40, sellPrice: 10, files: ['obsidian.png', 'obsidian.png', 'obsidian.png', 'obsidian.png', 'obsidian.png', 'obsidian.png'], hardness: 10.0 },
            21: { name: 'Gravel', price: 2, sellPrice: 1, files: ['gravel.png', 'gravel.png', 'gravel.png', 'gravel.png', 'gravel.png', 'gravel.png'], hardness: 0.6 },
            22: { name: 'Clay', price: 4, sellPrice: 2, files: ['clay.png', 'clay.png', 'clay.png', 'clay.png', 'clay.png', 'clay.png'], hardness: 0.6 },
            23: { name: 'Birch Log', price: 5, sellPrice: 2, files: ['birch_log.png', 'birch_log.png', 'birch_log_top.png', 'birch_log_top.png', 'birch_log.png', 'birch_log.png'], hardness: 2.0 },
            24: { name: 'Birch Planks', price: 4, sellPrice: 1, files: ['birch_planks.png', 'birch_planks.png', 'birch_planks.png', 'birch_planks.png', 'birch_planks.png', 'birch_planks.png'], hardness: 2.0 },
            25: { name: 'Spruce Log', price: 5, sellPrice: 2, files: ['spruce_log.png', 'spruce_log.png', 'spruce_log_top.png', 'spruce_log_top.png', 'spruce_log.png', 'spruce_log.png'], hardness: 2.0 },
            26: { name: 'Spruce Planks', price: 4, sellPrice: 1, files: ['spruce_planks.png', 'spruce_planks.png', 'spruce_planks.png', 'spruce_planks.png', 'spruce_planks.png', 'spruce_planks.png'], hardness: 2.0 },
            27: { name: 'White Wool', price: 6, sellPrice: 2, files: ['wool_white.png', 'wool_white.png', 'wool_white.png', 'wool_white.png', 'wool_white.png', 'wool_white.png'], hardness: 0.8 },
            28: { name: 'Red Wool', price: 6, sellPrice: 2, files: ['wool_red.png', 'wool_red.png', 'wool_red.png', 'wool_red.png', 'wool_red.png', 'wool_red.png'], hardness: 0.8 },
            29: { name: 'Green Wool', price: 6, sellPrice: 2, files: ['wool_green.png', 'wool_green.png', 'wool_green.png', 'wool_green.png', 'wool_green.png', 'wool_green.png'], hardness: 0.8 },
            30: { name: 'Blue Wool', price: 6, sellPrice: 2, files: ['wool_blue.png', 'wool_blue.png', 'wool_blue.png', 'wool_blue.png', 'wool_blue.png', 'wool_blue.png'], hardness: 0.8 },
            31: { name: 'Yellow Wool', price: 6, sellPrice: 2, files: ['wool_yellow.png', 'wool_yellow.png', 'wool_yellow.png', 'wool_yellow.png', 'wool_yellow.png', 'wool_yellow.png'], hardness: 0.8 },
            32: { name: 'Black Wool', price: 6, sellPrice: 2, files: ['wool_black.png', 'wool_black.png', 'wool_black.png', 'wool_black.png', 'wool_black.png', 'wool_black.png'], hardness: 0.8 },
            33: { name: 'Orange Wool', price: 6, sellPrice: 2, files: ['wool_orange.png', 'wool_orange.png', 'wool_orange.png', 'wool_orange.png', 'wool_orange.png', 'wool_orange.png'], hardness: 0.8 },
            34: { name: 'Furnace', price: 16, sellPrice: 4, files: ['furnace_side.png', 'furnace_side.png', 'furnace_top.png', 'furnace_top.png', 'furnace_front.png', 'furnace_side.png'], hardness: 3.5 },
            35: { name: 'Crafting Table', price: 10, sellPrice: 3, files: ['crafting_side.png', 'crafting_side.png', 'crafting_top.png', 'planks.png', 'crafting_side.png', 'crafting_side.png'], hardness: 2.5 },
            36: { name: 'Bookshelf', price: 15, sellPrice: 4, files: ['bookshelf.png', 'bookshelf.png', 'planks.png', 'planks.png', 'bookshelf.png', 'bookshelf.png'], hardness: 1.5 },
            37: { name: 'TNT', price: 50, sellPrice: 10, files: ['tnt_side.png', 'tnt_side.png', 'tnt_top.png', 'tnt_bottom.png', 'tnt_side.png', 'tnt_side.png'], hardness: 0.0 },
            38: { name: 'Pumpkin', price: 8, sellPrice: 2, files: ['pumpkin_side.png', 'pumpkin_side.png', 'pumpkin_top.png', 'pumpkin_top.png', 'pumpkin_face.png', 'pumpkin_side.png'], hardness: 1.0 },
            39: { name: 'Melon', price: 8, sellPrice: 2, files: ['melon_side.png', 'melon_side.png', 'melon_top.png', 'melon_top.png', 'melon_side.png', 'melon_side.png'], hardness: 1.0 },
            40: { name: 'Cyan Wool', price: 6, sellPrice: 2, files: ['wool_cyan.png', 'wool_cyan.png', 'wool_cyan.png', 'wool_cyan.png', 'wool_cyan.png', 'wool_cyan.png'], hardness: 0.8 },
            41: { name: 'Purple Wool', price: 6, sellPrice: 2, files: ['wool_purple.png', 'wool_purple.png', 'wool_purple.png', 'wool_purple.png', 'wool_purple.png', 'wool_purple.png'], hardness: 0.8 },
            42: { name: 'Pink Wool', price: 6, sellPrice: 2, files: ['wool_pink.png', 'wool_pink.png', 'wool_pink.png', 'wool_pink.png', 'wool_pink.png', 'wool_pink.png'], hardness: 0.8 },
            43: { name: 'Lime Wool', price: 6, sellPrice: 2, files: ['wool_lime.png', 'wool_lime.png', 'wool_lime.png', 'wool_lime.png', 'wool_lime.png', 'wool_lime.png'], hardness: 0.8 },
            44: { name: 'Snow Block', price: 2, sellPrice: 1, files: ['snow.png', 'snow.png', 'snow.png', 'snow.png', 'snow.png', 'snow.png'], hardness: 0.2 },
            45: { name: 'Ice', price: 4, sellPrice: 1, files: ['ice.png', 'ice.png', 'ice.png', 'ice.png', 'ice.png', 'ice.png'], transparent: true, opacity: 0.6, hardness: 0.5 },
            46: { name: 'Cactus', price: 4, sellPrice: 1, files: ['cactus_side.png', 'cactus_side.png', 'cactus_top.png', 'cactus_bottom.png', 'cactus_side.png', 'cactus_side.png'], transparent: true, hardness: 0.4 },
            47: { name: 'Mycelium', price: 4, sellPrice: 1, files: ['mycelium_side.png', 'mycelium_side.png', 'mycelium_top.png', 'dirt.png', 'mycelium_side.png', 'mycelium_side.png'], hardness: 0.6 },
            48: { name: 'Netherrack', price: 2, sellPrice: 1, files: ['netherrack.png', 'netherrack.png', 'netherrack.png', 'netherrack.png', 'netherrack.png', 'netherrack.png'], hardness: 0.4 },
            49: { name: 'Soul Sand', price: 4, sellPrice: 1, files: ['soul_sand.png', 'soul_sand.png', 'soul_sand.png', 'soul_sand.png', 'soul_sand.png', 'soul_sand.png'], hardness: 0.5 },
            50: { name: 'Glowstone', price: 16, sellPrice: 4, files: ['glowstone.png', 'glowstone.png', 'glowstone.png', 'glowstone.png', 'glowstone.png', 'glowstone.png'], light: 0xFFFFFF, hardness: 0.3 },
            51: { name: 'End Stone', price: 10, sellPrice: 3, files: ['end_stone.png', 'end_stone.png', 'end_stone.png', 'end_stone.png', 'end_stone.png', 'end_stone.png'], hardness: 3.0 },
            52: { name: 'Iron Block', price: 100, sellPrice: 15, files: ['iron_block.png', 'iron_block.png', 'iron_block.png', 'iron_block.png', 'iron_block.png', 'iron_block.png'], hardness: 5.0 },
            53: { name: 'Gold Block', price: 150, sellPrice: 25, files: ['gold_block.png', 'gold_block.png', 'gold_block.png', 'gold_block.png', 'gold_block.png', 'gold_block.png'], hardness: 3.0 },
            54: { name: 'Diamond Block', price: 500, sellPrice: 20, files: ['diamond_block.png', 'diamond_block.png', 'diamond_block.png', 'diamond_block.png', 'diamond_block.png', 'diamond_block.png'], hardness: 5.0 },
            55: { name: 'Brick', price: 6, sellPrice: 2, files: ['brick.png', 'brick.png', 'brick.png', 'brick.png', 'brick.png', 'brick.png'], hardness: 2.0 },
            56: { name: 'Sandstone', price: 4, sellPrice: 1, files: ['sandstone_side.png', 'sandstone_side.png', 'sandstone_top.png', 'sandstone_bottom.png', 'sandstone_side.png', 'sandstone_side.png'], hardness: 0.8 },
            57: { name: 'Quartz', price: 10, sellPrice: 3, files: ['quartz_side.png', 'quartz_side.png', 'quartz_top.png', 'quartz_bottom.png', 'quartz_side.png', 'quartz_side.png'], hardness: 0.8 },
            58: { name: 'Grey Wool', price: 6, sellPrice: 2, files: ['wool_grey.png', 'wool_grey.png', 'wool_grey.png', 'wool_grey.png', 'wool_grey.png', 'wool_grey.png'], hardness: 0.8 },
            59: { name: 'Lt Grey Wool', price: 6, sellPrice: 2, files: ['wool_light_grey.png', 'wool_light_grey.png', 'wool_light_grey.png', 'wool_light_grey.png', 'wool_light_grey.png', 'wool_light_grey.png'], hardness: 0.8 },
            60: { name: 'Magenta Wool', price: 6, sellPrice: 2, files: ['wool_magenta.png', 'wool_magenta.png', 'wool_magenta.png', 'wool_magenta.png', 'wool_magenta.png', 'wool_magenta.png'], hardness: 0.8 },
            61: { name: 'Light Blue Wool', price: 6, sellPrice: 2, files: ['wool_light_blue.png', 'wool_light_blue.png', 'wool_light_blue.png', 'wool_light_blue.png', 'wool_light_blue.png', 'wool_light_blue.png'], hardness: 0.8 },
            62: { name: 'Sponge', price: 10, sellPrice: 2, files: ['sponge.png', 'sponge.png', 'sponge.png', 'sponge.png', 'sponge.png', 'sponge.png'], hardness: 0.6 },
            63: { name: 'Redstone Lamp', price: 16, sellPrice: 4, files: ['redstone_lamp_off.png', 'redstone_lamp_off.png', 'redstone_lamp_off.png', 'redstone_lamp_off.png', 'redstone_lamp_off.png', 'redstone_lamp_off.png'], hardness: 0.3 },
            64: { name: 'Hay Bale', price: 4, sellPrice: 1, files: ['hay_side.png', 'hay_side.png', 'hay_top.png', 'hay_top.png', 'hay_side.png', 'hay_side.png'], hardness: 0.5 },
            100: { name: 'Claim Block', price: 500, sellPrice: 50, files: ['sponge.png', 'sponge.png', 'sponge.png', 'sponge.png', 'sponge.png', 'sponge.png'], hardness: 5.0 }
        };

        let scene, camera, renderer, raycaster, atlas, sunLight, ambientLight, clouds, stars;
        let playerGroup, externalModel, cameraPivot, modelLoaded = false;
        let world = {}, chunkMeshes = {}, clickables = [];
        let activeTorches = []; 

        let vel = new THREE.Vector3(), onGround = false, gameTime = 0, running = false, paused = false;
        let isTouch = 'ontouchstart' in window;
        let activeHotbarIndex = 0;
        let hotbarSlots = [0, 0, 0, 0, 0, 0, 0, 0];
        let selectionBox;
        const keys = {}, joy = { x: 0, y: 0, id: null, sx: 0, sy: 0 };
        const touchState = { id: null, lx: 0, ly: 0, sx: 0, sy: 0, timer: null, moved: false, startTime: 0 };

        let isFlying = false, lastJumpTime = 0, isTouchingDown = false, isTouchingUp = false, povMode = 0, povDist = 4;
        let mixer, actions = {}, activeAction;

        function makeTextSprite(message) {
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            canvas.width = 512;
            canvas.height = 128;
            
            context.font = "Bold 40px sans-serif";
            context.fillStyle = "rgba(0,0,0,0.5)";
            const metrics = context.measureText(message);
            const textWidth = metrics.width;
            
            context.beginPath();
            context.roundRect(256 - textWidth/2 - 15, 40, textWidth + 30, 50, 10);
            context.fill();
            
            context.textAlign = "center";
            context.textBaseline = "middle";
            context.fillStyle = "white";
            context.strokeStyle = "black";
            context.lineWidth = 4;
            context.strokeText(message, 256, 65);
            context.fillText(message, 256, 65);
            
            const texture = new THREE.CanvasTexture(canvas);
            const spriteMaterial = new THREE.SpriteMaterial({ map: texture });
            const sprite = new THREE.Sprite(spriteMaterial);
            sprite.scale.set(2, 0.5, 1);
            return sprite;
        }

        async function saveUserData() {
            if (!currentUser) return;
            try {
                const userRef = doc(db, 'artifacts', APP_ID, 'public', 'data', 'users', userId);
                await setDoc(userRef, {
                    coins: coins,
                    inventory: inventory,
                    hotbarSlots: hotbarSlots,
                    currentSkin: currentSkin,
                    activeToolId: activeTool ? activeTool.id : null,
                    updatedAt: serverTimestamp()
                }, { merge: true });
            } catch (e) {
                console.error("Error saving user data: ", e);
            }
        }

        async function loadUserData() {
            if (!currentUser) return;
            try {
                const userRef = doc(db, 'artifacts', APP_ID, 'public', 'data', 'users', userId);
                const docSnap = await getDoc(userRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    coins = data.coins || 0;
                    inventory = data.inventory || new Array(30).fill(null);
                    hotbarSlots = data.hotbarSlots || [0, 0, 0, 0, 0, 0, 0, 0];
                    currentSkin = data.currentSkin || 'default';
                    if (data.activeToolId) activeTool = { ...TOOLS[data.activeToolId], id: data.activeToolId };
                    
                    updateUI();
                    updateHotbarUI();
                } else {
                    // Initial setup for new user
                    coins = 100;
                    inventory[0] = { id: 1, count: 64 };
                    inventory[1] = { id: 2, count: 64 };
                    inventory[2] = { id: 3, count: 64 };
                    hotbarSlots = [1, 2, 3, 0, 0, 0, 0, 0];
                    await saveUserData();
                }
            } catch (e) {
                console.error("Error loading user data: ", e);
            }
        }

        function initNetwork() {
            const playersRef = collection(db, 'artifacts', APP_ID, 'public', 'data', 'players');
            onSnapshot(playersRef, (snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    const data = change.doc.data();
                    const pid = change.doc.id;
                    if (pid === userId) return;
                    if (change.type === "added" || change.type === "modified") {
                        if (!otherPlayers[pid]) createRemotePlayer(pid, data);
                        updateRemotePlayer(pid, data);
                    }
                    if (change.type === "removed") removeRemotePlayer(pid);
                });
            });

            const claimsRef = collection(db, 'artifacts', APP_ID, 'public', 'data', 'claims');
            onSnapshot(claimsRef, (snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    if(change.type === "added") {
                        const d = change.doc.data();
                        landClaims[change.doc.id] = d.owner;
                    }
                });
            });

            const worldRef = collection(db, 'artifacts', APP_ID, 'public', 'data', 'world_changes');
            const q = query(worldRef, orderBy('timestamp', 'asc'));
            onSnapshot(q, (snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    if (change.type === "added") {
                        const d = change.doc.data();
                        const key = `${Math.floor(d.x)},${Math.floor(d.y)},${Math.floor(d.z)}`;
                        if (d.action === 'PLACE') {
                            world[key] = d.id;
                            if (d.id === 10) activeTorches.push({x:d.x, y:d.y, z:d.z, k:key});
                        } else if (d.action === 'BREAK') {
                            world[key] = 0;
                            if (d.prevId === 10) activeTorches = activeTorches.filter(t => t.k !== key);
                        }
                        if (running) refreshChunk(d.x, d.z);
                    }
                });
            });

            const chatRef = collection(db, 'artifacts', APP_ID, 'public', 'data', 'chat');
            const chatQ = query(chatRef, orderBy('timestamp', 'desc'), limit(20));
            onSnapshot(chatQ, (snapshot) => {
                const log = document.getElementById('chat-log');
                const msgs = [];
                snapshot.forEach(doc => msgs.push(doc.data()));
                msgs.reverse();
                log.innerHTML = '';
                msgs.forEach(m => {
                    const el = document.createElement('div');
                    el.innerHTML = `<span style="color:#0f0">[${m.user.substr(0,8)}]</span>: ${m.text}`;
                    log.appendChild(el);
                });
                log.scrollTop = log.scrollHeight;
            });
        }

        async function startGame(user) {
            currentUser = user;
            userId = user.uid;
            userDisplayName = user.displayName || 'Player';
            document.getElementById('user-display-id').innerText = userId.substr(0,8);
            
            await loadUserData(); // - Load from Firebase on start
            init();
            initNetwork();
            document.getElementById('loading').style.display = 'none';
            document.querySelectorAll('.ctrl').forEach(c => c.style.display = 'block');
            running = true;
            animate();
            setInterval(syncPlayer, 50);
        }

        function init() {
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            renderer = new THREE.WebGLRenderer({ antialias: false });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setClearColor(0x87CEEB);
            renderer.shadowMap.enabled = true;
            document.body.appendChild(renderer.domElement);

            raycaster = new THREE.Raycaster();
            raycaster.far = 10;

            const ambient = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambient);
            sunLight = new THREE.DirectionalLight(0xffffff, 0.8);
            sunLight.position.set(50, 100, 50);
            scene.add(sunLight);

            atlas = createTextureAtlas();

            playerGroup = new THREE.Group();
            playerGroup.position.set(0, 30, 0);
            scene.add(playerGroup);

            cameraPivot = new THREE.Group();
            playerGroup.add(cameraPivot);
            cameraPivot.add(camera);
            camera.position.set(0, PLAYER_HEIGHT, 0);

            const loader = new THREE.GLTFLoader();
            loader.load('https://threejs.org/examples/models/gltf/RobotExpressive/RobotExpressive.glb', (gltf) => {
                externalModel = gltf.scene;
                externalModel.scale.set(0.2, 0.2, 0.2);
                externalModel.position.y = 0.05;
                externalModel.rotation.y = Math.PI;
                playerGroup.add(externalModel);
                
                mixer = new THREE.AnimationMixer(externalModel);
                gltf.animations.forEach(anim => actions[anim.name] = mixer.clipAction(anim));
                activeAction = actions['Idle'];
                activeAction.play();
                
                modelLoaded = true;
                updateSkin();
            });

            const selGeo = new THREE.BoxGeometry(1.01, 1.01, 1.01);
            const selMat = new THREE.MeshBasicMaterial({ color: 0xffffff, wireframe: true, transparent: true, opacity: 0.5 });
            selectionBox = new THREE.Mesh(selGeo, selMat);
            scene.add(selectionBox);

            generateWorld();
            setupEvents();
            updateUI();
            updateHotbarUI();
        }

        function createTextureAtlas() {
            const canvas = document.createElement('canvas');
            canvas.width = ATLAS_COLS * 32;
            canvas.height = ATLAS_ROWS * 32;
            const ctx = canvas.getContext('2d');
            ctx.imageSmoothingEnabled = false;

            const tex = new THREE.CanvasTexture(canvas);
            tex.magFilter = THREE.NearestFilter;
            tex.minFilter = THREE.NearestFilter;

            const loader = new THREE.ImageLoader();
            const draw = (id, faceIdx, file) => {
                loader.load(`https://raw.githubusercontent.com/PolyMarsDev/Voxel-Island/main/textures/${file}`, (img) => {
                    const idx = (id - 1) * 6 + faceIdx;
                    const x = (idx % ATLAS_COLS) * 32;
                    const y = Math.floor(idx / ATLAS_COLS) * 32;
                    ctx.drawImage(img, x, y, 32, 32);
                    tex.needsUpdate = true;
                    if (running) Object.values(chunkMeshes).forEach(m => m.material.map.needsUpdate = true);
                });
            };

            Object.keys(BLOCKS).forEach(id => {
                BLOCKS[id].files.forEach((f, i) => draw(id, i, f));
            });
            return tex;
        }

        function generateWorld() {
            for (let x = -CHUNK_SIZE; x < CHUNK_SIZE; x++) {
                for (let z = -CHUNK_SIZE; z < CHUNK_SIZE; z++) {
                    const h = Math.floor(Math.sin(x/8)*Math.cos(z/8)*4 + 20);
                    for (let y = 0; y < h; y++) {
                        let id = 3;
                        if (y === h - 1) id = 1;
                        else if (y > h - 4) id = 2;
                        world[`${x},${y},${z}`] = id;
                    }
                    world[`${x},0,${z}`] = 9; 
                }
            }
            for (let cx = -RENDER_DIST; cx <= RENDER_DIST; cx++) {
                for (let cz = -RENDER_DIST; cz <= RENDER_DIST; cz++) {
                    buildChunk(cx * CHUNK_SIZE, cz * CHUNK_SIZE);
                }
            }
        }

        function buildChunk(cx, cz) {
            const positions = [], uvs = [], indices = [];
            let count = 0;

            for (let x = cx; x < cx + CHUNK_SIZE; x++) {
                for (let z = cz; z < cz + CHUNK_SIZE; z++) {
                    for (let y = 0; y < 64; y++) {
                        const id = world[`${x},${y},${z}`];
                        if (!id || id === 0 || id === 11) continue;

                        const faces = [
                            { n: [1, 0, 0], v: [[1, 0, 0], [1, 1, 0], [1, 1, 1], [1, 0, 1]], uv: 0 },
                            { n: [-1, 0, 0], v: [[0, 0, 1], [0, 1, 1], [0, 1, 0], [0, 0, 0]], uv: 1 },
                            { n: [0, 1, 0], v: [[0, 1, 1], [1, 1, 1], [1, 1, 0], [0, 1, 0]], uv: 2 },
                            { n: [0, -1, 0], v: [[0, 0, 0], [1, 0, 0], [1, 0, 1], [0, 0, 1]], uv: 3 },
                            { n: [0, 0, 1], v: [[0, 0, 1], [1, 0, 1], [1, 1, 1], [0, 1, 1]], uv: 4 },
                            { n: [0, 0, -1], v: [[1, 0, 0], [0, 0, 0], [0, 1, 0], [1, 1, 0]], uv: 5 }
                        ];

                        faces.forEach((f) => {
                            const ni = x + f.n[0], nj = y + f.n[1], nk = z + f.n[2];
                            const neighbor = world[`${ni},${nj},${nk}`];
                            if (!neighbor || neighbor === 0 || BLOCKS[neighbor]?.transparent || neighbor === 11) {
                                f.v.forEach(v => positions.push(x + v[0], y + v[1], z + v[2]));
                                const uvIdx = (id - 1) * 6 + f.uv;
                                const u = (uvIdx % ATLAS_COLS) / ATLAS_COLS;
                                const v = 1 - (Math.floor(uvIdx / ATLAS_COLS) + 1) / ATLAS_ROWS;
                                uvs.push(u, v, u + 1/ATLAS_COLS, v, u + 1/ATLAS_COLS, v + 1/ATLAS_ROWS, u, v + 1/ATLAS_ROWS);
                                indices.push(count, count + 1, count + 2, count, count + 2, count + 3);
                                count += 4;
                            }
                        });
                    }
                }
            }

            const geo = new THREE.BufferGeometry();
            geo.setAttribute('position', new THREE.Float32BufferAttribute(positions, 3));
            geo.setAttribute('uv', new THREE.Float32BufferAttribute(uvs, 2));
            geo.setIndex(indices);
            geo.computeVertexNormals();

            if (chunkMeshes[`${cx},${cz}`]) {
                scene.remove(chunkMeshes[`${cx},${cz}`]);
                clickables = clickables.filter(c => c !== chunkMeshes[`${cx},${cz}`]);
            }

            const mesh = new THREE.Mesh(geo, new THREE.MeshLambertMaterial({ map: atlas, transparent: true, alphaTest: 0.1 }));
            scene.add(mesh);
            chunkMeshes[`${cx},${cz}`] = mesh;
            clickables.push(mesh);
        }

        function refreshChunk(x, z) {
            const cx = Math.floor(x / CHUNK_SIZE) * CHUNK_SIZE;
            const cz = Math.floor(z / CHUNK_SIZE) * CHUNK_SIZE;
            buildChunk(cx, cz);
            if (x % CHUNK_SIZE === 0) buildChunk(cx - CHUNK_SIZE, cz);
            if (x % CHUNK_SIZE === CHUNK_SIZE - 1) buildChunk(cx + CHUNK_SIZE, cz);
            if (z % CHUNK_SIZE === 0) buildChunk(cx, cz - CHUNK_SIZE);
            if (z % CHUNK_SIZE === CHUNK_SIZE - 1) buildChunk(cx, cz + CHUNK_SIZE);
        }

        async function syncPlayer() {
            if (!currentUser) return;
            const playerRef = doc(db, 'artifacts', APP_ID, 'public', 'data', 'players', userId);
            await setDoc(playerRef, {
                x: playerGroup.position.x,
                y: playerGroup.position.y,
                z: playerGroup.position.z,
                ry: playerGroup.rotation.y,
                display: userDisplayName,
                skin: currentSkin,
                lastSeen: serverTimestamp()
            }, { merge: true });
        }

        function createRemotePlayer(id, data) {
            const group = new THREE.Group();
            const label = makeTextSprite(data.display || 'Player');
            label.position.y = 1.2;
            group.add(label);

            if (modelLoaded) {
                const model = SkeletonUtils.clone(externalModel);
                model.scale.set(0.2, 0.2, 0.2);
                model.rotation.y = Math.PI;
                group.add(model);
                group.userData.model = model;
                
                const remoteMixer = new THREE.AnimationMixer(model);
                group.userData.mixer = remoteMixer;
                
                if (data.skin && SKINS[data.skin]) {
                    model.traverse(child => {
                        if (child.isMesh && SKINS[data.skin].color) child.material.color.setHex(SKINS[data.skin].color);
                    });
                }
            }

            scene.add(group);
            otherPlayers[id] = group;
        }

        function updateRemotePlayer(id, data) {
            const p = otherPlayers[id];
            if (!p) return;
            p.position.set(data.x, data.y, data.z);
            p.rotation.y = data.ry;
        }

        function removeRemotePlayer(id) {
            if (otherPlayers[id]) {
                scene.remove(otherPlayers[id]);
                delete otherPlayers[id];
            }
        }

        function setupEvents() {
            window.addEventListener('keydown', (e) => {
                keys[e.code] = true;
                if (e.code.startsWith('Digit')) {
                    const slot = parseInt(e.code.replace('Digit', '')) - 1;
                    if (slot >= 0 && slot < 8) { activeHotbarIndex = slot; updateHotbarUI(); }
                }
                if (e.code === 'KeyE') toggleInventory();
                if (e.code === 'Space') {
                    const now = performance.now();
                    if (now - lastJumpTime < 250) { isFlying = !isFlying; vel.y = 0; }
                    lastJumpTime = now;
                }
            });
            window.addEventListener('keyup', (e) => keys[e.code] = false);

            const canvas = renderer.domElement;
            canvas.addEventListener('mousedown', (e) => {
                if (!paused) {
                    if (e.button === 0) handleInteraction(true);
                    else if (e.button === 2) handleInteraction(false);
                }
            });

            if (isTouch) {
                const zone = document.getElementById('joy-zone');
                zone.addEventListener('touchstart', (e) => {
                    const t = e.targetTouches[0];
                    joy.id = t.identifier;
                    joy.sx = t.clientX; joy.sy = t.clientY;
                });
                window.addEventListener('touchmove', (e) => {
                    for (let i=0; i<e.changedTouches.length; i++) {
                        const t = e.changedTouches[i];
                        if (t.identifier === joy.id) {
                            joy.x = Math.max(-1, Math.min(1, (t.clientX - joy.sx)/40));
                            joy.y = Math.max(-1, Math.min(1, (t.clientY - joy.sy)/40));
                            document.getElementById('joy-nub').style.transform = `translate(calc(-50% + ${joy.x*30}px), calc(-50% + ${joy.y*30}px))`;
                        } else if (t.identifier === touchState.id) {
                            const dx = t.clientX - touchState.lx;
                            const dy = t.clientY - touchState.ly;
                            playerGroup.rotation.y -= dx * 0.005;
                            cameraPivot.rotation.x = Math.max(-Math.PI/2, Math.min(Math.PI/2, cameraPivot.rotation.x - dy * 0.005));
                            touchState.lx = t.clientX; touchState.ly = t.clientY;
                            if (Math.abs(t.clientX - touchState.sx) > 10 || Math.abs(t.clientY - touchState.sy) > 10) touchState.moved = true;
                        }
                    }
                });
                window.addEventListener('touchend', (e) => {
                    for (let i=0; i<e.changedTouches.length; i++) {
                        const t = e.changedTouches[i];
                        if (t.identifier === joy.id) {
                            joy.id = null; joy.x = 0; joy.y = 0;
                            document.getElementById('joy-nub').style.transform = `translate(-50%, -50%)`;
                        } else if (t.identifier === touchState.id) {
                            if (!touchState.moved && (performance.now() - touchState.startTime < 300)) handleInteraction(true);
                            touchState.id = null;
                        }
                    }
                });
                canvas.addEventListener('touchstart', (e) => {
                    if (touchState.id === null) {
                        const t = e.targetTouches[0];
                        touchState.id = t.identifier;
                        touchState.lx = t.clientX; touchState.ly = t.clientY;
                        touchState.sx = t.clientX; touchState.sy = t.clientY;
                        touchState.moved = false;
                        touchState.startTime = performance.now();
                    }
                });
            }

            document.getElementById('resume-btn').onclick = () => togglePause();
            document.getElementById('pause-btn').onclick = () => togglePause();
            document.getElementById('chat-toggle-btn').onclick = () => {
                const chat = document.getElementById('chat-container');
                chat.style.display = chat.style.display === 'flex' ? 'none' : 'flex';
            };
            document.getElementById('chat-send-btn').onclick = sendChatMessage;
            document.getElementById('chat-input').onkeydown = (e) => { if (e.key === 'Enter') sendChatMessage(); };
            document.getElementById('inv-btn').onclick = toggleInventory;
            document.getElementById('close-inv').onclick = toggleInventory;
            document.getElementById('shop-btn').onclick = toggleShop;
            document.getElementById('close-shop').onclick = toggleShop;
            document.getElementById('del-mode-btn').onclick = () => {
                deleteMode = !deleteMode;
                document.getElementById('del-mode-btn').innerText = `DELETE MODE: ${deleteMode ? 'ON' : 'OFF'}`;
            };
            document.getElementById('shop-mode-btn').onclick = () => {
                shopSellMode = !shopSellMode;
                document.getElementById('shop-mode-btn').innerText = `MODE: ${shopSellMode ? 'SELL' : 'BUY'}`;
                renderShop();
            };
            document.getElementById('jump-btn').onclick = () => { if (onGround || isFlying) vel.y = 5; };
            document.getElementById('cam-btn').onclick = () => {
                povMode = (povMode + 1) % 3;
                if (povMode === 0) { camera.position.set(0, PLAYER_HEIGHT, 0); camera.lookAt(new THREE.Vector3(0, PLAYER_HEIGHT, -1)); }
            };
            document.getElementById('fs-btn').onclick = () => {
                if (!document.fullscreenElement) document.documentElement.requestFullscreen();
                else document.exitFullscreen();
            };
        }

        async function handleInteraction(isPrimary) {
            raycaster.setFromCamera({x:0, y:0}, camera);
            const intersects = raycaster.intersectObjects(clickables);
            if (intersects.length > 0) {
                const hit = intersects[0];
                const pos = hit.point.clone().add(hit.face.normal.clone().multiplyScalar(isPrimary ? -0.5 : 0.5)).floor();
                const key = `${pos.x},${pos.y},${pos.z}`;
                
                if (isPrimary) {
                    const blockId = world[key];
                    if (blockId && !BLOCKS[blockId].indestructible) {
                        if (landClaims[key] && landClaims[key] !== userId) return alert("This land is claimed!");
                        
                        await updateWorldDoc(pos.x, pos.y, pos.z, 'BREAK', 0, blockId);
                        addToInventory(blockId);
                        if (blockId >= 12 && blockId <= 16) { 
                            coins += (blockId - 11) * 5; 
                            updateUI();
                            saveUserData(); // - Save coins to Firebase
                        }
                    }
                } else {
                    const activeId = hotbarSlots[activeHotbarIndex];
                    if (activeId > 0 && !world[key]) {
                        if (activeId === 100) { 
                            const claimKey = `${Math.floor(pos.x/16)},${Math.floor(pos.z/16)}`;
                            if (landClaims[claimKey]) return alert("Chunk already claimed!");
                            await setDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'claims', claimKey), { owner: userId, x: pos.x, z: pos.z });
                        }
                        await updateWorldDoc(pos.x, pos.y, pos.z, 'PLACE', activeId);
                        removeFromHotbar(activeHotbarIndex);
                    }
                }
            }
        }

        async function updateWorldDoc(x, y, z, action, id, prevId = 0) {
            await addDoc(collection(db, 'artifacts', APP_ID, 'public', 'data', 'world_changes'), {
                x, y, z, action, id, prevId, timestamp: serverTimestamp()
            });
        }

        function addToInventory(id, count = 1) {
            let slot = inventory.find(s => s && s.id === id);
            if (slot) slot.count += count;
            else {
                const empty = inventory.findIndex(s => s === null);
                if (empty !== -1) inventory[empty] = { id, count };
            }
            // Auto-fill hotbar if needed
            for (let i=0; i<8; i++) {
                if (hotbarSlots[i] === 0) {
                    hotbarSlots[i] = id;
                    break;
                }
            }
            updateHotbarUI();
            saveUserData(); // - Save inventory to Firebase
        }

        function removeFromHotbar(index) {
            const id = hotbarSlots[index];
            const invSlot = inventory.find(s => s && s.id === id);
            if (invSlot) {
                invSlot.count--;
                if (invSlot.count <= 0) {
                    inventory[inventory.indexOf(invSlot)] = null;
                    hotbarSlots[index] = 0;
                }
            }
            updateHotbarUI();
            saveUserData(); // - Save inventory change to Firebase
        }

        async function sendChatMessage() {
            const input = document.getElementById('chat-input');
            const text = input.value.trim();
            if (text) {
                await addDoc(collection(db, 'artifacts', APP_ID, 'public', 'data', 'chat'), {
                    user: userDisplayName, text, timestamp: serverTimestamp()
                });
                input.value = '';
            }
        }

        function togglePause() {
            paused = !paused;
            document.getElementById('pause-menu').style.display = paused ? 'flex' : 'none';
        }

        function toggleInventory() {
            const inv = document.getElementById('inventory-overlay');
            const visible = inv.style.display === 'flex';
            inv.style.display = visible ? 'none' : 'flex';
            if (!visible) renderInventory();
        }

        function toggleShop() {
            const shop = document.getElementById('shop-overlay');
            const visible = shop.style.display === 'flex';
            shop.style.display = visible ? 'none' : 'flex';
            if (!visible) renderShop();
        }

        function renderInventory() {
            const grid = document.getElementById('inventory-grid');
            grid.innerHTML = '';
            inventory.forEach((slot, i) => {
                const el = document.createElement('div');
                el.className = 'slot';
                if (slot) {
                    const canvas = document.createElement('canvas');
                    drawItem(canvas, slot.id);
                    el.appendChild(canvas);
                    const count = document.createElement('div');
                    count.className = 'slot-count';
                    count.innerText = slot.count;
                    el.appendChild(count);
                    el.onclick = () => {
                        if (deleteMode) { inventory[i] = null; renderInventory(); saveUserData(); }
                        else {
                            hotbarSlots[activeHotbarIndex] = slot.id;
                            updateHotbarUI();
                            toggleInventory();
                        }
                    };
                }
                grid.appendChild(el);
            });
        }

        let currentShopTab = 'blocks';
        window.switchShopTab = (tab) => {
            currentShopTab = tab;
            document.querySelectorAll('.shop-tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`.shop-tab[onclick="switchShopTab('${tab}')"]`).classList.add('active');
            renderShop();
        };

        function renderShop() {
            const grid = document.getElementById('shop-grid');
            grid.innerHTML = '';
            
            if (currentShopTab === 'blocks') {
                Object.keys(BLOCKS).forEach(id => {
                    const b = BLOCKS[id];
                    if (!b.price && !shopSellMode) return;
                    const el = document.createElement('div');
                    el.className = 'shop-item';
                    const canvas = document.createElement('canvas');
                    drawItem(canvas, id);
                    el.innerHTML = `<div class="shop-name">${b.name}</div>`;
                    el.insertBefore(canvas, el.firstChild);
                    el.innerHTML += `<div class="shop-price">${shopSellMode ? b.sellPrice : b.price}C</div>`;
                    el.onclick = () => {
                        if (shopSellMode) {
                            const invIdx = inventory.findIndex(s => s && s.id == id);
                            if (invIdx !== -1) {
                                coins += b.sellPrice;
                                inventory[invIdx].count--;
                                if (inventory[invIdx].count <= 0) inventory[invIdx] = null;
                                updateUI();
                                renderShop();
                                saveUserData(); // - Sync after shop activity
                            }
                        } else if (coins >= b.price) {
                            coins -= b.price;
                            addToInventory(parseInt(id));
                            updateUI();
                            saveUserData(); // - Sync after shop activity
                        }
                    };
                    grid.appendChild(el);
                });
            } else if (currentShopTab === 'tools') {
                Object.keys(TOOLS).forEach(id => {
                    const t = TOOLS[id];
                    const el = document.createElement('div');
                    el.className = 'shop-item';
                    el.innerHTML = `<div class="shop-name">${t.name}</div><div class="shop-price">${t.price}C</div>`;
                    el.onclick = () => {
                        if (coins >= t.price) {
                            coins -= t.price;
                            activeTool = { ...t, id };
                            currentMineDelay = 400 * t.speedMod;
                            updateUI();
                            saveUserData(); // - Sync after shop activity
                        }
                    };
                    grid.appendChild(el);
                });
            } else if (currentShopTab === 'skins') {
                Object.keys(SKINS).forEach(id => {
                    const s = SKINS[id];
                    const el = document.createElement('div');
                    el.className = 'shop-item';
                    el.innerHTML = `<div class="shop-name">${s.name}</div><div class="shop-price">${s.price}C</div>`;
                    el.onclick = () => {
                        if (coins >= s.price || currentSkin === id) {
                            if (currentSkin !== id) coins -= s.price;
                            currentSkin = id;
                            updateSkin();
                            updateUI();
                            saveUserData(); // - Sync after shop activity
                        }
                    };
                    grid.appendChild(el);
                });
            }
        }

        function drawItem(canvas, id) {
            canvas.width = 32; canvas.height = 32;
            const ctx = canvas.getContext('2d');
            ctx.imageSmoothingEnabled = false;
            const b = BLOCKS[id];
            if (!b) return;
            const loader = new THREE.ImageLoader();
            loader.load(`https://raw.githubusercontent.com/PolyMarsDev/Voxel-Island/main/textures/${b.files[2]}`, (img) => {
                ctx.drawImage(img, 0, 0, 32, 32);
            });
        }

        function updateUI() {
            document.getElementById('coin-display').innerText = `COINS: ${coins}`;
        }

        function updateHotbarUI() {
            const container = document.getElementById('hotbar-slots');
            container.innerHTML = '';
            hotbarSlots.forEach((id, i) => {
                const el = document.createElement('div');
                el.className = `slot ${i === activeHotbarIndex ? 'active' : ''}`;
                if (id > 0) {
                    const canvas = document.createElement('canvas');
                    drawItem(canvas, id);
                    el.appendChild(canvas);
                    const invSlot = inventory.find(s => s && s.id === id);
                    if (invSlot) {
                        const count = document.createElement('div');
                        count.className = 'slot-count';
                        count.innerText = invSlot.count;
                        el.appendChild(count);
                    }
                }
                el.onclick = () => { activeHotbarIndex = i; updateHotbarUI(); };
                container.appendChild(el);
            });
        }

        function updateSkin() {
            if (!externalModel) return;
            const s = SKINS[currentSkin];
            externalModel.traverse(child => {
                if (child.isMesh) {
                    if (s.color) child.material.color.setHex(s.color);
                    else child.material.color.setHex(0xffffff);
                }
            });
        }

        function animate() {
            if (!running) return;
            requestAnimationFrame(animate);
            const dt = 0.016;

            if (!paused) {
                gameTime += dt;
                const sunAngle = (gameTime / DAY_LENGTH_SECONDS) * Math.PI * 2;
                sunLight.position.set(Math.cos(sunAngle)*100, Math.sin(sunAngle)*100, 50);
                sunLight.intensity = Math.max(0, Math.sin(sunAngle)) * 0.8 + 0.2;
                renderer.setClearColor(new THREE.Color(0x87CEEB).multiplyScalar(sunLight.intensity));

                updatePhysics(dt);
                if (mixer) mixer.update(dt);
                
                // Selection highlight
                raycaster.setFromCamera({x:0, y:0}, camera);
                const intersects = raycaster.intersectObjects(clickables);
                if (intersects.length > 0) {
                    const hit = intersects[0];
                    const pos = hit.point.clone().add(hit.face.normal.clone().multiplyScalar(-0.5)).floor();
                    selectionBox.position.set(pos.x + 0.5, pos.y + 0.5, pos.z + 0.5);
                    selectionBox.visible = true;
                } else selectionBox.visible = false;

                // POV adjustment
                if (povMode > 0) {
                    const dist = povMode === 1 ? -povDist : povDist;
                    camera.position.set(0, PLAYER_HEIGHT + 1, dist);
                    camera.lookAt(playerGroup.position.clone().add(new THREE.Vector3(0, PLAYER_HEIGHT, 0)));
                    if (externalModel) externalModel.visible = true;
                } else {
                    camera.position.set(0, PLAYER_HEIGHT, 0);
                    if (externalModel) externalModel.visible = false;
                }
            }

            renderer.render(scene, camera);
        }

        function updatePhysics(dt) {
            let moveX = 0, moveZ = 0;
            if (keys['KeyW']) moveZ -= 1;
            if (keys['KeyS']) moveZ += 1;
            if (keys['KeyA']) moveX -= 1;
            if (keys['KeyD']) moveX += 1;
            
            if (isTouch) { moveX += joy.x; moveZ -= joy.y; }

            const speed = isFlying ? 15 : 5;
            const dir = new THREE.Vector3(moveX, 0, moveZ).normalize().applyQuaternion(playerGroup.quaternion).multiplyScalar(speed);
            
            vel.x = dir.x;
            vel.z = dir.z;

            if (isFlying) {
                if (keys['Space']) vel.y = speed;
                else if (keys['ShiftLeft']) vel.y = -speed;
                else vel.y = 0;
            } else {
                vel.y -= 15 * dt;
                if (onGround && keys['Space']) vel.y = 6;
            }

            const nextPos = playerGroup.position.clone().add(vel.clone().multiplyScalar(dt));
            
            // Basic collision
            onGround = false;
            const check = (p) => world[`${Math.floor(p.x)},${Math.floor(p.y)},${Math.floor(p.z)}`];
            if (!check({x:nextPos.x, y:nextPos.y, z:nextPos.z}) && !check({x:nextPos.x, y:nextPos.y+1, z:nextPos.z})) {
                playerGroup.position.copy(nextPos);
            } else {
                if (vel.y < 0) onGround = true;
                vel.y = 0;
            }

            if (playerGroup.position.y < -10) playerGroup.position.set(0, 35, 0);

            // Animation state
            if (modelLoaded) {
                const isMoving = Math.abs(vel.x) > 0.1 || Math.abs(vel.z) > 0.1;
                const nextAction = isMoving ? actions['Walking'] : actions['Idle'];
                if (activeAction !== nextAction) {
                    activeAction.fadeOut(0.2);
                    nextAction.reset().fadeIn(0.2).play();
                    activeAction = nextAction;
                }
            }
        }

        setPersistence(auth, browserLocalPersistence).then(() => {
            onAuthStateChanged(auth, (user) => {
                if (user) startGame(user);
                else { 
                    document.getElementById('loading-text').innerText = 'READY TO CONNECT'; 
                    document.getElementById('start-btn').style.display = 'block'; 
                }
            });
        });

        clouds = new THREE.Mesh(new THREE.BoxGeometry(100, 2, 100), new THREE.MeshBasicMaterial({ color: 0xffffff, transparent: true, opacity: 0.5 })); clouds.position.y = 45; scene.add(clouds);
        const starGeo = new THREE.BufferGeometry(), starPos = []; for(let i=0; i<1500; i++) starPos.push((Math.random()-0.5)*100, Math.random()*50+10, (Math.random()-0.5)*100);
        starGeo.setAttribute('position', new THREE.Float32BufferAttribute(starPos, 3)); stars = new THREE.Points(starGeo, new THREE.PointsMaterial({ color: 0xffffff, size: 0.1, transparent: true, opacity: 0 })); scene.add(stars); 
        
        document.getElementById('start-btn').onclick = async () => {
            const provider = new GoogleAuthProvider();
            try { await signInWithPopup(auth, provider); } catch (e) { console.error(e); }
        };

        window.addEventListener('resize', () => { 
            camera.aspect = window.innerWidth / window.innerHeight; 
            camera.updateProjectionMatrix(); 
            renderer.setSize(window.innerWidth, window.innerHeight); 
        });
    </script>
</body>
</html>

