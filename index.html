<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Voxel Pocket - Multiplayer Edition</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');

        body { margin: 0; overflow: hidden; background: #000; touch-action: none; user-select: none; font-family: 'Press Start 2P', cursive; }
        #ui { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
        
        #crosshair {
            position: absolute; top: 50%; left: 50%; width: 20px; height: 20px;
            transform: translate(-50%, -50%); display: flex; align-items: center; justify-content: center;
        }
        #crosshair::before { content: ''; position: absolute; width: 16px; height: 2px; background: rgba(255,255,255,0.8); mix-blend-mode: difference; }
        #crosshair::after { content: ''; position: absolute; width: 2px; height: 16px; background: rgba(255,255,255,0.8); mix-blend-mode: difference; }

        #break-progress {
            position: absolute; top: 50%; left: 50%; width: 40px; height: 40px;
            border: 4px solid rgba(0,0,0,0.5); border-top-color: #fff; border-radius: 50%;
            transform: translate(-50%, -50%) scale(0);
            z-index: 10; transition: transform 0.1s linear;
        }

        .corner-btn {
            position: absolute; top: 10px; width: 36px; height: 36px;
            background: rgba(0,0,0,0.5); border: 2px solid #fff; color: #fff;
            display: flex; align-items: center; justify-content: center;
            font-size: 7px; cursor: pointer; pointer-events: auto;
            box-shadow: 0 3px 0 rgba(0,0,0,0.3); z-index: 100;
        }
        #pause-btn { left: 10px; }
        #chat-toggle-btn { left: 52px; }
        #fs-btn { right: 52px; } 
        #cam-btn { right: 10px; }
        #shop-btn { top: 52px; left: 10px; width: 78px; font-size: 8px; background: #DAA520; color: #000; }
        
        .corner-btn:active { transform: translateY(2px); box-shadow: none; }

        #coin-display {
            position: absolute; top: 10px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.6); border: 2px solid #DAA520; color: #FFD700;
            padding: 8px 15px; font-size: 10px; z-index: 90; text-shadow: 1px 1px #000;
        }

        #hotbar-container {
            position: absolute; bottom: 8px; left: 50%; transform: translateX(-50%);
            display: flex; gap: 2px; background: rgba(0,0,0,0.4); padding: 2px; border: 3px solid #111; pointer-events: auto;
            max-width: 95vw; overflow-x: auto;
        }
        .slot {
            width: 34px; height: 34px; border: 3px solid #555; background: #8B8B8B;
            display: flex; justify-content: center; align-items: center; cursor: pointer; position: relative;
            box-shadow: inset 2px 2px #AAA, inset -2px -2px #333; flex-shrink: 0;
        }
        .slot.active { border-color: #FFF; background: #AAA; z-index: 2; transform: scale(1.05); box-shadow: 0 0 8px white; }
        .slot canvas { width: 24px; height: 24px; image-rendering: pixelated; pointer-events: none; }
        .slot-count { position: absolute; bottom: 2px; right: 2px; font-size: 8px; color: #fff; text-shadow: 1px 1px #000; pointer-events: none; }
        
        #inv-btn {
            width: 34px; height: 34px; background: #8B8B8B; border: 3px solid #111; color: #fff;
            display: flex; align-items: center; justify-content: center; font-size: 7px;
            margin-right: 3px; cursor: pointer; text-shadow: 1px 1px #000;
            box-shadow: inset 2px 2px #AAA, inset -2px -2px #333; flex-shrink: 0;
        }

        .ctrl { position: absolute; pointer-events: auto; z-index: 50; display: none; }
        #joy-zone { bottom: 20px; left: 15px; width: 110px; height: 110px; background: rgba(255,255,255,0.1); border: 2px solid rgba(255,255,255,0.2); border-radius: 50%; }
        #joy-nub { position: absolute; top: 50%; left: 50%; width: 40px; height: 40px; background: #fff; border-radius: 50%; transform: translate(-50%, -50%); opacity: 0.4; pointer-events: none; }
        
        #flight-controls {
            position: absolute; bottom: 20px; right: 15px;
            display: flex; flex-direction: column; gap: 8px; align-items: center;
        }
        .action-btn {
            width: 50px; height: 50px; border-radius: 50%;
            background: rgba(0,0,0,0.3); border: 2px solid rgba(255,255,255,0.4);
            display: flex; align-items: center; justify-content: center;
            backdrop-filter: blur(2px);
        }
        .action-btn svg { width: 24px; height: 24px; fill: white; opacity: 0.8; }

        #chat-container {
            position: fixed; top: 95px; left: 10px; width: 240px; height: 140px;
            display: none; flex-direction: column; z-index: 2500; pointer-events: auto;
        }
        #chat-header { background: rgba(0,0,0,0.8); color: #0f0; padding: 4px; font-size: 6px; border-bottom: 2px solid #333; }
        #chat-log { flex-grow: 1; background: rgba(0,0,0,0.6); color: #fff; padding: 6px; font-size: 7px; overflow-y: auto; display: flex; flex-direction: column-reverse; }
        #chat-input-wrapper { display: flex; background: rgba(0,0,0,0.8); border: 2px solid #555; }
        #chat-input { flex-grow: 1; background: transparent; border: none; color: #fff; padding: 8px; font-family: 'Press Start 2P'; font-size: 7px; outline: none; width: 50%; }
        #chat-send-btn { background: #555; color: #fff; border: none; padding: 0 8px; cursor: pointer; font-family: 'Press Start 2P'; font-size: 7px; }

        #inventory-overlay, #shop-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 2000; pointer-events: auto; }
        #inventory-grid, #shop-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 4px; background: #8B8B8B; padding: 15px; border: 4px solid #111; max-height: 70vh; overflow-y: auto; }
        
        #pause-menu { position: fixed; inset: 0; background: rgba(0,0,0,0.85); display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 3000; pointer-events: auto; }
        .menu-card { background: #8B8B8B; padding: 20px; border: 4px solid #000; display: flex; flex-direction: column; gap: 10px; width: 200px; }
        .menu-btn { padding: 12px; background: #777; color: #fff; border: 3px solid #000; font-family: 'Press Start 2P'; font-size: 9px; cursor: pointer; text-align: center; }

        #loading { position: fixed; inset: 0; background: #111; color: #fff; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 1000; }
        #start-btn { padding: 12px 30px; font-family: 'Press Start 2P'; font-size: 12px; cursor: pointer; background: #777; color: #fff; border: 4px solid #000; margin-top: 15px; display: none;}
        
        #del-mode-btn { background: #a33; margin-top: 5px; width: 100%; font-size: 8px; padding: 8px; border: 2px solid #000; color: white; cursor: pointer; }
        
        #shop-mode-btn { background: #2ecc71; margin-bottom: 5px; width: 100%; font-size: 8px; padding: 8px; border: 2px solid #000; color: white; cursor: pointer; text-align: center; }
        
        .shop-item { width: 50px; height: 60px; background: #555; border: 2px solid #000; display: flex; flex-direction: column; align-items: center; justify-content: space-between; cursor: pointer; padding: 2px; }
        .shop-item:hover { background: #666; }
        .shop-price { font-size: 6px; color: #FFD700; margin-bottom: 2px; text-align: center; }
        .shop-name { font-size: 5px; color: #fff; margin-top: 2px; text-align: center; width: 100%; white-space: nowrap; overflow: hidden; }
        .shop-tabs { display: flex; gap: 5px; margin-bottom: 10px; }
        .shop-tab { padding: 8px; background: #555; color: white; border: 2px solid #000; font-size: 8px; cursor: pointer; }
        .shop-tab.active { background: #DAA520; color: black; }
        .shop-item canvas { image-rendering: pixelated; margin: 2px 0; }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/utils/SkeletonUtils.js"></script>
</head>
<body>
    <div id="loading">
        <h1 style="font-size: 18px; text-shadow: 3px 3px #555; text-align: center;">VOXEL POCKET</h1>
        <p id="loading-text" style="font-size: 7px; color: #aaa; margin-top: 10px;">INITIALIZING...</p>
        <button id="start-btn">ENTER WORLD (GOOGLE LOGIN)</button>
    </div>

    <div id="ui">
        <div id="coin-display">COINS: 0</div>
        <div id="crosshair"></div>
        <div id="break-progress"></div>
        
        <div id="pause-btn" class="corner-btn ctrl">||</div>
        <div id="chat-toggle-btn" class="corner-btn ctrl">MSG</div>
        <div id="fs-btn" class="corner-btn ctrl">FULL</div>
        <div id="cam-btn" class="corner-btn ctrl">POV</div>
        <div id="shop-btn" class="corner-btn ctrl">SHOP</div>

        <div id="chat-container">
            <div id="chat-header">ID: <span id="user-display-id">...</span></div>
            <div id="chat-log"></div>
            <div id="chat-input-wrapper">
                <input type="text" id="chat-input" placeholder="..." maxlength="50">
                <button id="chat-send-btn">></button>
            </div>
        </div>

        <div id="hotbar-container">
            <div id="inv-btn">INV</div>
            <div id="hotbar-slots" style="display: flex; gap: 2px;"></div>
        </div>
        <div id="joy-zone" class="ctrl"><div id="joy-nub"></div></div>
        
        <div id="flight-controls" class="ctrl">
            <div id="up-btn" class="action-btn" style="display: none;">
                <svg viewBox="0 0 24 24"><path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"/></svg>
            </div>
            <div id="jump-btn" class="action-btn">
                <svg viewBox="0 0 24 24"><path d="M12 2L4.5 20.29l.71.71L12 18l6.79 3 .71-.71z"/></svg>
            </div>
            <div id="down-btn" class="action-btn" style="display: none;">
                <svg viewBox="0 0 24 24"><path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6z"/></svg>
            </div>
        </div>
    </div>

    <div id="pause-menu">
        <div class="menu-card">
            <div style="text-align: center; margin-bottom: 5px; color: #fff; text-shadow: 2px 2px #000; font-size: 10px;">PAUSED</div>
            <div id="resume-btn" class="menu-btn">RESUME</div>
            <div id="quit-btn" class="menu-btn" style="background: #a33;">QUIT</div>
        </div>
    </div>

    <div id="inventory-overlay">
        <div style="color: white; margin-bottom: 10px; font-size: 10px;">INVENTORY</div>
        <div id="inventory-grid"></div>
        <button id="del-mode-btn">DELETE MODE: OFF</button>
        <button id="close-inv" class="menu-btn" style="margin-top: 15px; width: 160px;">CLOSE</button>
    </div>

    <div id="shop-overlay">
        <div style="color: #DAA520; margin-bottom: 5px; font-size: 10px;">ITEM SHOP</div>
        <div id="shop-mode-btn">MODE: BUY</div>
        <div style="color: #888; margin-bottom: 10px; font-size: 6px;">L-CLICK: BUY | R-CLICK: SELL</div>
        <div class="shop-tabs">
            <div class="shop-tab active" onclick="switchShopTab('blocks')">BLOCKS</div>
            <div class="shop-tab" onclick="switchShopTab('tools')">TOOLS</div>
            <div class="shop-tab" onclick="switchShopTab('skins')">SKINS</div>
        </div>
        <div id="shop-grid"></div>
        <button id="close-shop" class="menu-btn" style="margin-top: 15px; width: 160px;">CLOSE</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, browserLocalPersistence, setPersistence } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, limit, setDoc, doc, serverTimestamp, deleteDoc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBgQaeWlxecgunDZo8xHBorRVIrZ8K4YJ8",
            authDomain: "pixelbox-bca1b.firebaseapp.com",
            projectId: "pixelbox-bca1b",
            storageBucket: "pixelbox-bca1b.firebasestorage.app",
            messagingSenderId: "709778027442",
            appId: "1:709778027442:web:c2959397d3285e1f24eaab",
            measurementId: "G-8B9GQFDVY1"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const APP_ID = 'pixelbox_v1'; 

        const CHUNK_SIZE = 16;
        const RENDER_DIST = 3;
        const PLAYER_HEIGHT = 1.62;
        const PLAYER_RADIUS = 0.3;
        const DAY_LENGTH_SECONDS = 300; 
        
        let currentMineDelay = 400; 
        const MOVE_THRESHOLD = 15;

        let currentUser = null;
        let userId = 'Guest';
        let userDisplayName = 'Guest';
        let otherPlayers = {}; 
        let ATLAS_COLS = 8;
        let ATLAS_ROWS = 8;
        
        let coins = 0;
        let inventory = new Array(30).fill(null); 
        let deleteMode = false;
        let shopSellMode = false;
        let landClaims = {}; 
        let currentSkin = 'default';
        let activeTool = null;

        const TOOLS = {
            1001: { name: 'Wood Pick', tier: 1, price: 50, speedMod: 0.7, icon: 'wood_pick.png' },
            1002: { name: 'Stone Pick', tier: 2, price: 150, speedMod: 0.5, icon: 'stone_pick.png' },
            1003: { name: 'Iron Pick', tier: 3, price: 500, speedMod: 0.3, icon: 'iron_pick.png' },
            1004: { name: 'Diamond Pick', tier: 4, price: 1000, speedMod: 0.1, icon: 'diamond_pick.png' }
        };

        const SKINS = {
            'default': { name: 'Robot', price: 0, file: 'RobotExpressive.glb' },
            'blue': { name: 'Blue Bot', price: 200, file: 'RobotExpressive.glb', color: 0x0000ff },
            'red': { name: 'Red Bot', price: 200, file: 'RobotExpressive.glb', color: 0xff0000 },
            'gold': { name: 'Gold Bot', price: 1000, file: 'RobotExpressive.glb', color: 0xFFD700 }
        };

        const BLOCKS = {
            1: { name: 'Grass', price: 4, sellPrice: 1, files: ['grass_side.png', 'grass_side.png', 'grass_top.png', 'dirt.png', 'grass_side.png', 'grass_side.png'], hardness: 0.6 },
            2: { name: 'Dirt', price: 2, sellPrice: 1, files: ['dirt.png', 'dirt.png', 'dirt.png', 'dirt.png', 'dirt.png', 'dirt.png'], hardness: 0.5 },
            3: { name: 'Stone', price: 5, sellPrice: 2, files: ['stone.png', 'stone.png', 'stone.png', 'stone.png', 'stone.png', 'stone.png'], hardness: 1.5 },
            4: { name: 'Log', price: 5, sellPrice: 2, files: ['log_side.png', 'log_side.png', 'log_top.png', 'log_top.png', 'log_side.png', 'log_side.png'], hardness: 2.0 },
            5: { name: 'Leaves', price: 2, sellPrice: 1, files: ['leaves.png', 'leaves.png', 'leaves.png', 'leaves.png', 'leaves.png', 'leaves.png'], transparent: true, hardness: 0.2 },
            6: { name: 'Sand', price: 2, sellPrice: 1, files: ['sand.png', 'sand.png', 'sand.png', 'sand.png', 'sand.png', 'sand.png'], hardness: 0.5 },
            7: { name: 'Planks', price: 4, sellPrice: 1, files: ['planks.png', 'planks.png', 'planks.png', 'planks.png', 'planks.png', 'planks.png'], hardness: 2.0 },
            8: { name: 'Glass', price: 6, sellPrice: 2, files: ['glass.png', 'glass.png', 'glass.png', 'glass.png', 'glass.png', 'glass.png'], transparent: true, hardness: 0.3 },
            9: { name: 'Bedrock', files: ['bedrock.png', 'bedrock.png', 'bedrock.png', 'bedrock.png', 'bedrock.png', 'bedrock.png'], indestructible: true },
            10: { name: 'Torch', price: 5, sellPrice: 1, files: ['torch.png', 'torch.png', 'torch.png', 'torch.png', 'torch.png', 'torch.png'], isTorch: true, light: 0xFFA500, transparent: true, hardness: 0.1 },
            11: { name: 'Water', files: ['water.png', 'water.png', 'water.png', 'water.png', 'water.png', 'water.png'], transparent: true, isFluid: true, opacity: 0.7 },
            12: { name: 'Coal Ore', price: 10, sellPrice: 3, files: ['coal_ore.png', 'coal_ore.png', 'coal_ore.png', 'coal_ore.png', 'coal_ore.png', 'coal_ore.png'], hardness: 3.0 },
            13: { name: 'Iron Ore', price: 15, sellPrice: 4, files: ['iron_ore.png', 'iron_ore.png', 'iron_ore.png', 'iron_ore.png', 'iron_ore.png', 'iron_ore.png'], hardness: 3.0 },
            14: { name: 'Gold Ore', price: 20, sellPrice: 5, files: ['gold_ore.png', 'gold_ore.png', 'gold_ore.png', 'gold_ore.png', 'gold_ore.png', 'gold_ore.png'], hardness: 3.0 },
            15: { name: 'Diamond Ore', price: 30, sellPrice: 6, files: ['diamond_ore.png', 'diamond_ore.png', 'diamond_ore.png', 'diamond_ore.png', 'diamond_ore.png', 'diamond_ore.png'], hardness: 4.0 },
            16: { name: 'Emerald Ore', price: 30, sellPrice: 8, files: ['emerald_ore.png', 'emerald_ore.png', 'emerald_ore.png', 'emerald_ore.png', 'emerald_ore.png', 'emerald_ore.png'], hardness: 3.0 },
            17: { name: 'Cobblestone', price: 3, sellPrice: 1, files: ['cobblestone.png', 'cobblestone.png', 'cobblestone.png', 'cobblestone.png', 'cobblestone.png', 'cobblestone.png'], hardness: 2.0 },
            18: { name: 'Mossy Cobble', price: 4, sellPrice: 1, files: ['mossy_cobblestone.png', 'mossy_cobblestone.png', 'mossy_cobblestone.png', 'mossy_cobblestone.png', 'mossy_cobblestone.png', 'mossy_cobblestone.png'], hardness: 2.0 },
            19: { name: 'Stone Bricks', price: 4, sellPrice: 1, files: ['stone_bricks.png', 'stone_bricks.png', 'stone_bricks.png', 'stone_bricks.png', 'stone_bricks.png', 'stone_bricks.png'], hardness: 1.5 },
            20: { name: 'Obsidian', price: 40, sellPrice: 10, files: ['obsidian.png', 'obsidian.png', 'obsidian.png', 'obsidian.png', 'obsidian.png', 'obsidian.png'], hardness: 10.0 },
            21: { name: 'Gravel', price: 2, sellPrice: 1, files: ['gravel.png', 'gravel.png', 'gravel.png', 'gravel.png', 'gravel.png', 'gravel.png'], hardness: 0.6 },
            22: { name: 'Clay', price: 4, sellPrice: 2, files: ['clay.png', 'clay.png', 'clay.png', 'clay.png', 'clay.png', 'clay.png'], hardness: 0.6 },
            23: { name: 'Birch Log', price: 5, sellPrice: 2, files: ['birch_log.png', 'birch_log.png', 'birch_log_top.png', 'birch_log_top.png', 'birch_log.png', 'birch_log.png'], hardness: 2.0 },
            24: { name: 'Birch Planks', price: 4, sellPrice: 1, files: ['birch_planks.png', 'birch_planks.png', 'birch_planks.png', 'birch_planks.png', 'birch_planks.png', 'birch_planks.png'], hardness: 2.0 },
            25: { name: 'Spruce Log', price: 5, sellPrice: 2, files: ['spruce_log.png', 'spruce_log.png', 'spruce_log_top.png', 'spruce_log_top.png', 'spruce_log.png', 'spruce_log.png'], hardness: 2.0 },
            26: { name: 'Spruce Planks', price: 4, sellPrice: 1, files: ['spruce_planks.png', 'spruce_planks.png', 'spruce_planks.png', 'spruce_planks.png', 'spruce_planks.png', 'spruce_planks.png'], hardness: 2.0 },
            27: { name: 'White Wool', price: 6, sellPrice: 2, files: ['wool_white.png', 'wool_white.png', 'wool_white.png', 'wool_white.png', 'wool_white.png', 'wool_white.png'], hardness: 0.8 },
            28: { name: 'Red Wool', price: 6, sellPrice: 2, files: ['wool_red.png', 'wool_red.png', 'wool_red.png', 'wool_red.png', 'wool_red.png', 'wool_red.png'], hardness: 0.8 },
            29: { name: 'Green Wool', price: 6, sellPrice: 2, files: ['wool_green.png', 'wool_green.png', 'wool_green.png', 'wool_green.png', 'wool_green.png', 'wool_green.png'], hardness: 0.8 },
            30: { name: 'Blue Wool', price: 6, sellPrice: 2, files: ['wool_blue.png', 'wool_blue.png', 'wool_blue.png', 'wool_blue.png', 'wool_blue.png', 'wool_blue.png'], hardness: 0.8 },
            31: { name: 'Yellow Wool', price: 6, sellPrice: 2, files: ['wool_yellow.png', 'wool_yellow.png', 'wool_yellow.png', 'wool_yellow.png', 'wool_yellow.png', 'wool_yellow.png'], hardness: 0.8 },
            32: { name: 'Black Wool', price: 6, sellPrice: 2, files: ['wool_black.png', 'wool_black.png', 'wool_black.png', 'wool_black.png', 'wool_black.png', 'wool_black.png'], hardness: 0.8 },
            33: { name: 'Orange Wool', price: 6, sellPrice: 2, files: ['wool_orange.png', 'wool_orange.png', 'wool_orange.png', 'wool_orange.png', 'wool_orange.png', 'wool_orange.png'], hardness: 0.8 },
            34: { name: 'Furnace', price: 16, sellPrice: 4, files: ['furnace_side.png', 'furnace_side.png', 'furnace_top.png', 'furnace_top.png', 'furnace_front.png', 'furnace_side.png'], hardness: 3.5 },
            35: { name: 'Crafting Table', price: 10, sellPrice: 3, files: ['crafting_side.png', 'crafting_side.png', 'crafting_top.png', 'planks.png', 'crafting_side.png', 'crafting_side.png'], hardness: 2.5 },
            36: { name: 'Bookshelf', price: 15, sellPrice: 4, files: ['bookshelf.png', 'bookshelf.png', 'planks.png', 'planks.png', 'bookshelf.png', 'bookshelf.png'], hardness: 1.5 },
            37: { name: 'TNT', price: 50, sellPrice: 10, files: ['tnt_side.png', 'tnt_side.png', 'tnt_top.png', 'tnt_bottom.png', 'tnt_side.png', 'tnt_side.png'], hardness: 0.0 },
            38: { name: 'Pumpkin', price: 8, sellPrice: 2, files: ['pumpkin_side.png', 'pumpkin_side.png', 'pumpkin_top.png', 'pumpkin_top.png', 'pumpkin_face.png', 'pumpkin_side.png'], hardness: 1.0 },
            39: { name: 'Melon', price: 8, sellPrice: 2, files: ['melon_side.png', 'melon_side.png', 'melon_top.png', 'melon_top.png', 'melon_side.png', 'melon_side.png'], hardness: 1.0 },
            40: { name: 'Cyan Wool', price: 6, sellPrice: 2, files: ['wool_cyan.png', 'wool_cyan.png', 'wool_cyan.png', 'wool_cyan.png', 'wool_cyan.png', 'wool_cyan.png'], hardness: 0.8 },
            41: { name: 'Purple Wool', price: 6, sellPrice: 2, files: ['wool_purple.png', 'wool_purple.png', 'wool_purple.png', 'wool_purple.png', 'wool_purple.png', 'wool_purple.png'], hardness: 0.8 },
            42: { name: 'Pink Wool', price: 6, sellPrice: 2, files: ['wool_pink.png', 'wool_pink.png', 'wool_pink.png', 'wool_pink.png', 'wool_pink.png', 'wool_pink.png'], hardness: 0.8 },
            43: { name: 'Lime Wool', price: 6, sellPrice: 2, files: ['wool_lime.png', 'wool_lime.png', 'wool_lime.png', 'wool_lime.png', 'wool_lime.png', 'wool_lime.png'], hardness: 0.8 },
            44: { name: 'Snow Block', price: 2, sellPrice: 1, files: ['snow.png', 'snow.png', 'snow.png', 'snow.png', 'snow.png', 'snow.png'], hardness: 0.2 },
            45: { name: 'Ice', price: 4, sellPrice: 1, files: ['ice.png', 'ice.png', 'ice.png', 'ice.png', 'ice.png', 'ice.png'], transparent: true, opacity: 0.6, hardness: 0.5 },
            46: { name: 'Cactus', price: 4, sellPrice: 1, files: ['cactus_side.png', 'cactus_side.png', 'cactus_top.png', 'cactus_bottom.png', 'cactus_side.png', 'cactus_side.png'], transparent: true, hardness: 0.4 },
            47: { name: 'Mycelium', price: 4, sellPrice: 1, files: ['mycelium_side.png', 'mycelium_side.png', 'mycelium_top.png', 'dirt.png', 'mycelium_side.png', 'mycelium_side.png'], hardness: 0.6 },
            48: { name: 'Netherrack', price: 2, sellPrice: 1, files: ['netherrack.png', 'netherrack.png', 'netherrack.png', 'netherrack.png', 'netherrack.png', 'netherrack.png'], hardness: 0.4 },
            49: { name: 'Soul Sand', price: 4, sellPrice: 1, files: ['soul_sand.png', 'soul_sand.png', 'soul_sand.png', 'soul_sand.png', 'soul_sand.png', 'soul_sand.png'], hardness: 0.5 },
            50: { name: 'Glowstone', price: 16, sellPrice: 4, files: ['glowstone.png', 'glowstone.png', 'glowstone.png', 'glowstone.png', 'glowstone.png', 'glowstone.png'], light: 0xFFFFFF, hardness: 0.3 },
            51: { name: 'End Stone', price: 10, sellPrice: 3, files: ['end_stone.png', 'end_stone.png', 'end_stone.png', 'end_stone.png', 'end_stone.png', 'end_stone.png'], hardness: 3.0 },
            52: { name: 'Iron Block', price: 100, sellPrice: 15, files: ['iron_block.png', 'iron_block.png', 'iron_block.png', 'iron_block.png', 'iron_block.png', 'iron_block.png'], hardness: 5.0 },
            53: { name: 'Gold Block', price: 150, sellPrice: 25, files: ['gold_block.png', 'gold_block.png', 'gold_block.png', 'gold_block.png', 'gold_block.png', 'gold_block.png'], hardness: 3.0 },
            54: { name: 'Diamond Block', price: 500, sellPrice: 20, files: ['diamond_block.png', 'diamond_block.png', 'diamond_block.png', 'diamond_block.png', 'diamond_block.png', 'diamond_block.png'], hardness: 5.0 },
            55: { name: 'Brick', price: 6, sellPrice: 2, files: ['brick.png', 'brick.png', 'brick.png', 'brick.png', 'brick.png', 'brick.png'], hardness: 2.0 },
            56: { name: 'Sandstone', price: 4, sellPrice: 1, files: ['sandstone_side.png', 'sandstone_side.png', 'sandstone_top.png', 'sandstone_bottom.png', 'sandstone_side.png', 'sandstone_side.png'], hardness: 0.8 },
            57: { name: 'Quartz', price: 10, sellPrice: 3, files: ['quartz_side.png', 'quartz_side.png', 'quartz_top.png', 'quartz_bottom.png', 'quartz_side.png', 'quartz_side.png'], hardness: 0.8 },
            58: { name: 'Grey Wool', price: 6, sellPrice: 2, files: ['wool_grey.png', 'wool_grey.png', 'wool_grey.png', 'wool_grey.png', 'wool_grey.png', 'wool_grey.png'], hardness: 0.8 },
            59: { name: 'Lt Grey Wool', price: 6, sellPrice: 2, files: ['wool_light_grey.png', 'wool_light_grey.png', 'wool_light_grey.png', 'wool_light_grey.png', 'wool_light_grey.png', 'wool_light_grey.png'], hardness: 0.8 },
            60: { name: 'Magenta Wool', price: 6, sellPrice: 2, files: ['wool_magenta.png', 'wool_magenta.png', 'wool_magenta.png', 'wool_magenta.png', 'wool_magenta.png', 'wool_magenta.png'], hardness: 0.8 },
            61: { name: 'Light Blue Wool', price: 6, sellPrice: 2, files: ['wool_light_blue.png', 'wool_light_blue.png', 'wool_light_blue.png', 'wool_light_blue.png', 'wool_light_blue.png', 'wool_light_blue.png'], hardness: 0.8 },
            62: { name: 'Sponge', price: 10, sellPrice: 2, files: ['sponge.png', 'sponge.png', 'sponge.png', 'sponge.png', 'sponge.png', 'sponge.png'], hardness: 0.6 },
            63: { name: 'Redstone Lamp', price: 16, sellPrice: 4, files: ['redstone_lamp_off.png', 'redstone_lamp_off.png', 'redstone_lamp_off.png', 'redstone_lamp_off.png', 'redstone_lamp_off.png', 'redstone_lamp_off.png'], hardness: 0.3 },
            64: { name: 'Hay Bale', price: 4, sellPrice: 1, files: ['hay_side.png', 'hay_side.png', 'hay_top.png', 'hay_top.png', 'hay_side.png', 'hay_side.png'], hardness: 0.5 },
            100: { name: 'Claim Block', price: 500, sellPrice: 50, files: ['sponge.png', 'sponge.png', 'sponge.png', 'sponge.png', 'sponge.png', 'sponge.png'], hardness: 5.0 }
        };

        let scene, camera, renderer, raycaster, atlas, sunLight, ambientLight, clouds, stars;
        let playerGroup, externalModel, cameraPivot, modelLoaded = false;
        let world = {}, chunkMeshes = {}, clickables = [];
        let activeTorches = []; 

        let vel = new THREE.Vector3(), onGround = false, gameTime = 0, running = false, paused = false;
        let isTouch = 'ontouchstart' in window;
        let activeHotbarIndex = 0;
        let hotbarSlots = [0, 0, 0, 0, 0, 0, 0, 0];
        let selectionBox;
        const keys = {}, joy = { x: 0, y: 0, id: null, sx: 0, sy: 0 };
        const touchState = { id: null, lx: 0, ly: 0, sx: 0, sy: 0, timer: null, moved: false, startTime: 0 };

        let isFlying = false, lastJumpTime = 0, isTouchingDown = false, isTouchingUp = false, povMode = 0, povDist = 4;
        let mixer, actions = {}, activeAction;

        function makeTextSprite(message) {
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            canvas.width = 512;
            canvas.height = 128;
            
            context.font = "Bold 40px sans-serif";
            context.fillStyle = "rgba(0,0,0,0.5)";
            const metrics = context.measureText(message);
            const textWidth = metrics.width;
            
            context.beginPath();
            context.roundRect(256 - textWidth/2 - 15, 40, textWidth + 30, 50, 10);
            context.fill();
            
            context.textAlign = "center";
            context.textBaseline = "middle";
            context.fillStyle = "white";
            context.strokeStyle = "black";
            context.lineWidth = 4;
            context.strokeText(message, 256, 65);
            context.fillText(message, 256, 65);
            
            const texture = new THREE.CanvasTexture(canvas);
            const spriteMaterial = new THREE.SpriteMaterial({ map: texture });
            const sprite = new THREE.Sprite(spriteMaterial);
            sprite.scale.set(2, 0.5, 1);
            return sprite;
        }

        function initNetwork() {
            const playersRef = collection(db, 'artifacts', APP_ID, 'public', 'data', 'players');
            onSnapshot(playersRef, (snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    const data = change.doc.data();
                    const pid = change.doc.id;
                    if (pid === userId) return;
                    if (change.type === "added" || change.type === "modified") {
                        if (!otherPlayers[pid]) createRemotePlayer(pid, data);
                        updateRemotePlayer(pid, data);
                    }
                    if (change.type === "removed") removeRemotePlayer(pid);
                });
            });

            const claimsRef = collection(db, 'artifacts', APP_ID, 'public', 'data', 'claims');
            onSnapshot(claimsRef, (snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    if(change.type === "added") {
                        const d = change.doc.data();
                        landClaims[change.doc.id] = d.owner;
                    }
                });
            });

            const worldRef = collection(db, 'artifacts', APP_ID, 'public', 'data', 'world_changes');
            const q = query(worldRef, orderBy('timestamp', 'asc'));
            onSnapshot(q, (snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    if (change.type === "added") {
                        const d = change.doc.data();
                        const key = `${Math.floor(d.x)},${Math.floor(d.y)},${Math.floor(d.z)}`;
                        if (d.action === 'PLACE') {
                            world[key] = d.id;
                            if (d.id === 10) activeTorches.push({x:d.x, y:d.y, z:d.z, k:key});
                        } else if (d.action === 'BREAK') {
                            world[key] = 0;
                            if (d.prevId === 10) activeTorches = activeTorches.filter(t => t.k !== key);
                        }
                        if (running) refreshChunk(d.x, d.z);
                    }
                });
            });

            const chatRef = collection(db, 'artifacts', APP_ID, 'public', 'data', 'chat');
            const chatQ = query(chatRef, orderBy('timestamp', 'desc'), limit(20));
            onSnapshot(chatQ, (snapshot) => {
                const log = document.getElementById('chat-log');
                const msgs = [];
                snapshot.forEach(d => msgs.push(d.data()));
                log.innerHTML = msgs.map(m => `<div><span style="color:#0f0">[${m.user}]</span>: ${m.text}</div>`).join('');
            });
        }

        async function savePlayerData() {
            if (!currentUser) return;
            const playerDoc = doc(db, 'artifacts', APP_ID, 'public', 'data', 'players', userId);
            try {
                await updateDoc(playerDoc, {
                    coins: coins,
                    inventory: inventory,
                    currentSkin: currentSkin,
                    activeTool: activeTool,
                    lastSync: serverTimestamp()
                });
            } catch (e) {
                console.error("Save failed:", e);
                // Fallback for first-time creation if update fails
                await setDoc(playerDoc, {
                    coins: coins,
                    inventory: inventory,
                    currentSkin: currentSkin,
                    activeTool: activeTool,
                    x: playerGroup.position.x,
                    y: playerGroup.position.y,
                    z: playerGroup.position.z,
                    ry: playerGroup.rotation.y
                }, { merge: true });
            }
        }

        async function startGame(user) {
            currentUser = user;
            userId = user.uid;
            userDisplayName = user.displayName || user.email.split('@')[0];
            document.getElementById('user-display-id').innerText = userDisplayName;
            
            const playerDoc = doc(db, 'artifacts', APP_ID, 'public', 'data', 'players', userId);
            const snap = await getDoc(playerDoc);
            
            if (snap.exists()) {
                const d = snap.data();
                coins = d.coins || 0;
                inventory = d.inventory || new Array(30).fill(null);
                currentSkin = d.currentSkin || 'default';
                activeTool = d.activeTool || null;
                if (d.x !== undefined) playerGroup.position.set(d.x, d.y, d.z);
            } else {
                coins = 100;
                inventory = new Array(30).fill(null);
                inventory[0] = { id: 1, count: 64 };
                inventory[1] = { id: 2, count: 64 };
                await setDoc(playerDoc, { 
                    coins, inventory, currentSkin, activeTool,
                    x: 0, y: 15, z: 0, ry: 0, name: userDisplayName 
                });
            }

            document.getElementById('loading').style.display = 'none';
            running = true;
            initNetwork();
            updateUI();
            updateToolStats();
            loadPlayerModel(currentSkin);
            requestAnimationFrame(loop);
            
            setInterval(() => {
                if (running) {
                    setDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'players', userId), {
                        x: playerGroup.position.x, y: playerGroup.position.y, z: playerGroup.position.z,
                        ry: playerGroup.rotation.y, action: activeAction ? activeAction._clip.name : 'Idle',
                        timestamp: serverTimestamp(), name: userDisplayName,
                        coins: coins, inventory: inventory, currentSkin: currentSkin, activeTool: activeTool
                    }, { merge: true });
                }
            }, 100);
        }

        function updateUI() {
            document.getElementById('coin-display').innerText = `COINS: ${coins}`;
            const container = document.getElementById('hotbar-slots');
            container.innerHTML = '';
            for (let i = 0; i < 8; i++) {
                const slot = document.createElement('div');
                slot.className = `slot ${i === activeHotbarIndex ? 'active' : ''}`;
                const item = inventory[i];
                if (item) {
                    const canvas = document.createElement('canvas');
                    canvas.width = 32; canvas.height = 32;
                    drawItemIcon(canvas, item.id);
                    slot.appendChild(canvas);
                    const count = document.createElement('div');
                    count.className = 'slot-count';
                    count.innerText = item.count;
                    slot.appendChild(count);
                }
                slot.onclick = () => { activeHotbarIndex = i; updateUI(); };
                container.appendChild(slot);
            }
        }

        function drawItemIcon(canvas, id) {
            const ctx = canvas.getContext('2d');
            ctx.imageSmoothingEnabled = false;
            if (TOOLS[id]) {
                const img = new Image(); img.src = TOOLS[id].icon;
                img.onload = () => ctx.drawImage(img, 0, 0, 32, 32);
            } else if (BLOCKS[id]) {
                const img = new Image(); img.src = BLOCKS[id].files[2] || BLOCKS[id].files[0];
                img.onload = () => ctx.drawImage(img, 4, 4, 24, 24);
            }
        }

        function createRemotePlayer(pid, data) {
            const group = new THREE.Group();
            const label = makeTextSprite(data.name || pid.substring(0,5));
            label.position.y = 2.2;
            group.add(label);
            otherPlayers[pid] = { group, label };
            
            const loader = new THREE.GLTFLoader();
            loader.load('https://threejs.org/examples/models/gltf/RobotExpressive/RobotExpressive.glb', (gltf) => {
                const model = THREE.SkeletonUtils.clone(gltf.scene);
                model.scale.set(0.2, 0.2, 0.2);
                model.position.y = -0.1;
                const skin = SKINS[data.currentSkin || 'default'];
                if (skin && skin.color) {
                    model.traverse(child => { if (child.isMesh) child.material = child.material.clone(); child.material.color?.set(skin.color); });
                }
                group.add(model);
                const mixer = new THREE.AnimationMixer(model);
                const actions = {};
                gltf.animations.forEach(clip => { actions[clip.name] = mixer.clipAction(clip); });
                otherPlayers[pid].mixer = mixer;
                otherPlayers[pid].actions = actions;
                otherPlayers[pid].activeAction = actions['Idle'];
                otherPlayers[pid].activeAction.play();
                scene.add(group);
            });
        }

        function updateRemotePlayer(pid, data) {
            const p = otherPlayers[pid];
            if (!p) return;
            p.group.position.set(data.x, data.y, data.z);
            p.group.rotation.y = data.ry;
            if (p.actions && data.action && p.actions[data.action]) {
                if (p.activeAction._clip.name !== data.action) {
                    const next = p.actions[data.action];
                    p.activeAction.fadeOut(0.2);
                    next.reset().fadeIn(0.2).play();
                    p.activeAction = next;
                }
            }
        }

        function removeRemotePlayer(pid) {
            if (otherPlayers[pid]) {
                scene.remove(otherPlayers[pid].group);
                delete otherPlayers[pid];
            }
        }

        function initScene() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x87CEEB);
            scene.fog = new THREE.FogExp2(0x87CEEB, 0.02);
            
            camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
            renderer = new THREE.WebGLRenderer({ antialias: false });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            document.body.appendChild(renderer.domElement);

            playerGroup = new THREE.Group();
            playerGroup.position.set(0, 15, 0);
            cameraPivot = new THREE.Group();
            playerGroup.add(cameraPivot);
            scene.add(playerGroup);

            raycaster = new THREE.Raycaster();
            sunLight = new THREE.DirectionalLight(0xffffff, 1);
            sunLight.position.set(10, 20, 10);
            scene.add(sunLight);
            ambientLight = new THREE.AmbientLight(0x404040, 1);
            scene.add(ambientLight);

            const loader = new THREE.TextureLoader();
            atlas = loader.load('https://threejs.org/examples/textures/minecraft/atlas.png');
            atlas.magFilter = THREE.NearestFilter;
            atlas.minFilter = THREE.NearestFilter;

            const boxGeo = new THREE.BoxGeometry(1.001, 1.001, 1.001);
            const boxMat = new THREE.MeshBasicMaterial({ color: 0xffffff, wireframe: true, transparent: true, opacity: 0.5 });
            selectionBox = new THREE.Mesh(boxGeo, boxMat);
            scene.add(selectionBox);

            setPersistence(auth, browserLocalPersistence).then(() => {
                onAuthStateChanged(auth, (user) => {
                    if (user) startGame(user);
                    else { document.getElementById('loading-text').innerText = 'READY TO CONNECT'; document.getElementById('start-btn').style.display = 'block'; }
                });
            });

            clouds = new THREE.Mesh(new THREE.BoxGeometry(100, 2, 100), new THREE.MeshBasicMaterial({ color: 0xffffff, transparent: true, opacity: 0.5 })); clouds.position.y = 45; scene.add(clouds);
            const starGeo = new THREE.BufferGeometry(), starPos = []; for(let i=0; i<1500; i++) starPos.push((Math.random()-0.5)*100, Math.random()*50+10, (Math.random()-0.5)*100);
            starGeo.setAttribute('position', new THREE.Float32BufferAttribute(starPos, 3)); stars = new THREE.Points(starGeo, new THREE.PointsMaterial({ color: 0xffffff, size: 0.1, transparent: true, opacity: 0 })); scene.add(stars); 
            setupInput(); updateUI();
            document.getElementById('start-btn').onclick = async () => {
                const provider = new GoogleAuthProvider();
                try { await signInWithPopup(auth, provider); } catch (e) { console.error(e); }
            };
            window.addEventListener('resize', () => { camera.aspect = window.innerWidth / window.innerHeight; camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth, window.innerHeight); });
        }

        function loadPlayerModel(skinKey) {
            const skin = SKINS[skinKey];
            const loader = new THREE.GLTFLoader();
            loader.load('https://threejs.org/examples/models/gltf/RobotExpressive/RobotExpressive.glb', (gltf) => {
                if (externalModel) playerGroup.remove(externalModel);
                externalModel = gltf.scene;
                externalModel.scale.set(0.2, 0.2, 0.2);
                externalModel.position.y = -0.1;
                externalModel.rotation.y = Math.PI;
                if (skin.color) {
                    externalModel.traverse(child => { if (child.isMesh) child.material = child.material.clone(); child.material.color?.set(skin.color); });
                }
                playerGroup.add(externalModel);
                mixer = new THREE.AnimationMixer(externalModel);
                gltf.animations.forEach(clip => { actions[clip.name] = mixer.clipAction(clip); });
                activeAction = actions['Idle'];
                activeAction.play();
                modelLoaded = true;
                updatePOV();
            });
        }

        function updatePOV() {
            if (povMode === 0) {
                cameraPivot.position.set(0, PLAYER_HEIGHT, 0);
                camera.position.set(0, 0, 0);
                if (externalModel) externalModel.visible = false;
            } else if (povMode === 1) {
                cameraPivot.position.set(0, PLAYER_HEIGHT, 0);
                camera.position.set(0, 0, -povDist);
                camera.lookAt(playerGroup.position.clone().add(new THREE.Vector3(0, PLAYER_HEIGHT, 0)));
                if (externalModel) externalModel.visible = true;
            } else {
                cameraPivot.position.set(0, PLAYER_HEIGHT, 0);
                camera.position.set(0, 0, povDist);
                camera.lookAt(playerGroup.position.clone().add(new THREE.Vector3(0, PLAYER_HEIGHT, 0)));
                if (externalModel) externalModel.visible = true;
            }
        }

        function setupInput() {
            window.onkeydown = e => keys[e.code] = true;
            window.onkeyup = e => { keys[e.code] = false; if(e.code === 'Space') lastJumpTime = performance.now(); };
            
            const jz = document.getElementById('joy-zone');
            jz.ontouchstart = e => { joy.id = e.changedTouches[0].identifier; joy.sx = e.changedTouches[0].clientX; joy.sy = e.changedTouches[0].clientY; };
            jz.ontouchmove = e => {
                for(let t of e.changedTouches) if(t.identifier === joy.id) {
                    let dx = t.clientX - joy.sx, dy = t.clientY - joy.sy, d = Math.sqrt(dx*dx+dy*dy);
                    if(d>50) { dx*=50/d; dy*=50/d; }
                    joy.x = dx/50; joy.y = dy/50;
                    document.getElementById('joy-nub').style.transform = `translate(calc(-50% + ${dx}px), calc(-50% + ${dy}px))`;
                }
            };
            jz.ontouchend = () => { joy.id = null; joy.x = 0; joy.y = 0; document.getElementById('joy-nub').style.transform = 'translate(-50%, -50%)'; };

            window.ontouchstart = e => {
                if(e.target.closest('.ctrl, #hotbar-container, #ui button')) return;
                const t = e.changedTouches[0];
                touchState.id = t.identifier; touchState.sx = t.clientX; touchState.sy = t.clientY;
                touchState.lx = t.clientX; touchState.ly = t.clientY; touchState.moved = false;
                touchState.startTime = performance.now();
                touchState.timer = setTimeout(() => { if(!touchState.moved) startMining(); }, 500);
            };
            window.ontouchmove = e => {
                for(let t of e.changedTouches) if(t.identifier === touchState.id) {
                    let dx = t.clientX - touchState.lx, dy = t.clientY - touchState.ly;
                    playerGroup.rotation.y -= dx * 0.005;
                    cameraPivot.rotation.x = Math.max(-Math.PI/2, Math.min(Math.PI/2, cameraPivot.rotation.x - dy * 0.005));
                    touchState.lx = t.clientX; touchState.ly = t.clientY;
                    if(Math.hypot(t.clientX-touchState.sx, t.clientY-touchState.sy) > 10) { touchState.moved = true; stopMining(); }
                }
            };
            window.ontouchend = e => {
                for(let t of e.changedTouches) if(t.identifier === touchState.id) {
                    clearTimeout(touchState.timer); stopMining();
                    if(!touchState.moved && (performance.now()-touchState.startTime < 500)) handleInteraction(true);
                    touchState.id = null;
                }
            };

            window.onmousedown = e => { if(!paused && e.button === 0) startMining(); if(!paused && e.button === 2) handleInteraction(false); };
            window.onmouseup = () => stopMining();
            window.oncontextmenu = e => e.preventDefault();
            
            document.getElementById('pause-btn').onclick = () => togglePause(true);
            document.getElementById('resume-btn').onclick = () => togglePause(false);
            document.getElementById('quit-btn').onclick = () => location.reload();
            document.getElementById('inv-btn').onclick = openInventory;
            document.getElementById('close-inv').onclick = () => document.getElementById('inventory-overlay').style.display = 'none';
            document.getElementById('shop-btn').onclick = openShop;
            document.getElementById('close-shop').onclick = () => document.getElementById('shop-overlay').style.display = 'none';
            document.getElementById('chat-toggle-btn').onclick = () => {
                const c = document.getElementById('chat-container');
                c.style.display = (c.style.display === 'flex' ? 'none' : 'flex');
            };
            document.getElementById('chat-send-btn').onclick = sendChat;
            document.getElementById('chat-input').onkeydown = e => { if(e.key === 'Enter') sendChat(); };
            document.getElementById('fs-btn').onclick = () => { if(!document.fullscreenElement) document.documentElement.requestFullscreen(); else document.exitFullscreen(); };
            document.getElementById('cam-btn').onclick = () => { povMode = (povMode + 1) % 3; updatePOV(); };
            document.getElementById('jump-btn').ontouchstart = () => { keys['Space'] = true; };
            document.getElementById('jump-btn').ontouchend = () => { keys['Space'] = false; lastJumpTime = performance.now(); };
            document.getElementById('up-btn').ontouchstart = () => isTouchingUp = true;
            document.getElementById('up-btn').ontouchend = () => isTouchingUp = false;
            document.getElementById('down-btn').ontouchstart = () => isTouchingDown = true;
            document.getElementById('down-btn').ontouchend = () => isTouchingDown = false;
            document.getElementById('del-mode-btn').onclick = () => { deleteMode = !deleteMode; document.getElementById('del-mode-btn').innerText = `DELETE MODE: ${deleteMode?'ON':'OFF'}`; document.getElementById('del-mode-btn').style.background = deleteMode?'#f33':'#a33'; };
            document.getElementById('shop-mode-btn').onclick = () => { shopSellMode = !shopSellMode; document.getElementById('shop-mode-btn').innerText = `MODE: ${shopSellMode?'SELL':'BUY'}`; document.getElementById('shop-mode-btn').style.background = shopSellMode?'#e67e22':'#2ecc71'; };
        }

        async function sendChat() {
            const input = document.getElementById('chat-input');
            const val = input.value.trim();
            if (val) {
                await addDoc(collection(db, 'artifacts', APP_ID, 'public', 'data', 'chat'), {
                    user: userDisplayName, text: val, timestamp: serverTimestamp()
                });
                input.value = '';
            }
        }

        function togglePause(p) {
            paused = p;
            document.getElementById('pause-menu').style.display = p ? 'flex' : 'none';
            if (p) stopMining();
        }

        function getChunk(x, z) {
            const cx = Math.floor(x / CHUNK_SIZE), cz = Math.floor(z / CHUNK_SIZE);
            return `${cx},${cz}`;
        }

        function refreshChunk(x, z) {
            const ck = getChunk(x, z);
            if (chunkMeshes[ck]) {
                scene.remove(chunkMeshes[ck]);
                delete chunkMeshes[ck];
            }
        }

        function getBlock(x, y, z) {
            const k = `${Math.floor(x)},${Math.floor(y)},${Math.floor(z)}`;
            if (world[k] !== undefined) return world[k];
            if (y < 0) return 9;
            if (y < 10) return 3;
            if (y < 13) return 2;
            if (y === 13) return 1;
            return 0;
        }

        function buildChunk(cx, cz) {
            const matrix = new THREE.Matrix4();
            const mesh = new THREE.InstancedMesh(new THREE.BoxGeometry(1, 1, 1), new THREE.MeshLambertMaterial({ map: atlas }), CHUNK_SIZE * CHUNK_SIZE * 32);
            let count = 0;
            for (let x = 0; x < CHUNK_SIZE; x++) {
                for (let z = 0; z < CHUNK_SIZE; z++) {
                    for (let y = 0; y < 32; y++) {
                        const bx = cx * CHUNK_SIZE + x, bz = cz * CHUNK_SIZE + z;
                        const id = getBlock(bx, y, bz);
                        if (id > 0) {
                            matrix.setPosition(bx, y, bz);
                            mesh.setMatrixAt(count++, matrix);
                        }
                    }
                }
            }
            mesh.count = count;
            chunkMeshes[`${cx},${cz}`] = mesh;
            scene.add(mesh);
        }

        let mineTimer = null, mineProgress = 0, currentTarget = null;
        function startMining() {
            if (paused) return;
            mineProgress = 0;
            mineTimer = setInterval(async () => {
                raycaster.setFromCamera(new THREE.Vector2(0, 0), camera);
                const hits = raycaster.intersectObjects(Object.values(chunkMeshes));
                if (hits.length > 0 && hits[0].distance < 5) {
                    const p = hits[0].point.clone().add(hits[0].face.normal.clone().multiplyScalar(-0.5));
                    const bx = Math.floor(p.x), by = Math.floor(p.y), bz = Math.floor(p.z);
                    const id = getBlock(bx, by, bz);
                    if (id === 9) return;
                    
                    const block = BLOCKS[id] || { hardness: 1 };
                    mineProgress += (100 / (block.hardness * currentMineDelay * 0.1));
                    document.getElementById('break-progress').style.transform = `translate(-50%, -50%) scale(${mineProgress/100})`;
                    
                    if (mineProgress >= 100) {
                        stopMining();
                        await addDoc(collection(db, 'artifacts', APP_ID, 'public', 'data', 'world_changes'), {
                            x: bx, y: by, z: bz, action: 'BREAK', prevId: id, user: userId, timestamp: serverTimestamp()
                        });
                        addItemToInventory(id, 1);
                        savePlayerData();
                    }
                } else stopMining();
            }, 100);
        }

        function stopMining() {
            clearInterval(mineTimer);
            mineProgress = 0;
            document.getElementById('break-progress').style.transform = `translate(-50%, -50%) scale(0)`;
        }

        function addItemToInventory(id, count) {
            let found = false;
            for (let i = 0; i < 30; i++) {
                if (inventory[i] && inventory[i].id === id) {
                    inventory[i].count += count;
                    found = true;
                    break;
                }
            }
            if (!found) {
                for (let i = 0; i < 30; i++) {
                    if (!inventory[i]) {
                        inventory[i] = { id, count };
                        break;
                    }
                }
            }
            updateUI();
        }

        async function handleInteraction(isPlace) {
            raycaster.setFromCamera(new THREE.Vector2(0, 0), camera);
            const hits = raycaster.intersectObjects(Object.values(chunkMeshes));
            if (hits.length > 0 && hits[0].distance < 5) {
                const p = hits[0].point.clone().add(hits[0].face.normal.clone().multiplyScalar(isPlace ? 0.5 : -0.5));
                const bx = Math.floor(p.x), by = Math.floor(p.y), bz = Math.floor(p.z);
                
                if (isPlace) {
                    const item = inventory[activeHotbarIndex];
                    if (item && item.count > 0 && BLOCKS[item.id]) {
                        await addDoc(collection(db, 'artifacts', APP_ID, 'public', 'data', 'world_changes'), {
                            x: bx, y: by, z: bz, action: 'PLACE', id: item.id, user: userId, timestamp: serverTimestamp()
                        });
                        item.count--;
                        if (item.count <= 0) inventory[activeHotbarIndex] = null;
                        updateUI();
                        savePlayerData();
                    }
                }
            }
        }

        function openInventory() {
            const grid = document.getElementById('inventory-grid');
            grid.innerHTML = '';
            inventory.forEach((item, i) => {
                const slot = document.createElement('div');
                slot.className = 'slot';
                if (item) {
                    const canvas = document.createElement('canvas');
                    canvas.width = 32; canvas.height = 32;
                    drawItemIcon(canvas, item.id);
                    slot.appendChild(canvas);
                    const count = document.createElement('div');
                    count.className = 'slot-count';
                    count.innerText = item.count;
                    slot.appendChild(count);
                }
                slot.onclick = () => {
                    if (deleteMode) { inventory[i] = null; }
                    else if (i >= 8) {
                        const temp = inventory[activeHotbarIndex];
                        inventory[activeHotbarIndex] = inventory[i];
                        inventory[i] = temp;
                    }
                    openInventory(); updateUI(); savePlayerData();
                };
                grid.appendChild(slot);
            });
            document.getElementById('inventory-overlay').style.display = 'flex';
        }

        function openShop() {
            switchShopTab('blocks');
            document.getElementById('shop-overlay').style.display = 'flex';
        }

        window.switchShopTab = (tab) => {
            const grid = document.getElementById('shop-grid');
            grid.innerHTML = '';
            document.querySelectorAll('.shop-tab').forEach(t => t.classList.remove('active'));
            event?.target.classList.add('active');

            if (tab === 'blocks') {
                Object.entries(BLOCKS).forEach(([id, b]) => {
                    if (!b.price) return;
                    const item = document.createElement('div');
                    item.className = 'shop-item';
                    item.innerHTML = `<div class="shop-name">${b.name}</div><canvas id="shop-icon-${id}" width="32" height="32"></canvas><div class="shop-price">$${shopSellMode?b.sellPrice:b.price}</div>`;
                    item.onclick = () => {
                        if (shopSellMode) {
                            if (removeItemFromInventory(parseInt(id), 1)) { coins += b.sellPrice; }
                        } else if (coins >= b.price) {
                            coins -= b.price; addItemToInventory(parseInt(id), 1);
                        }
                        updateUI(); savePlayerData(); openShop();
                    };
                    grid.appendChild(item);
                    drawItemIcon(document.getElementById(`shop-icon-${id}`), parseInt(id));
                });
            } else if (tab === 'tools') {
                Object.entries(TOOLS).forEach(([id, t]) => {
                    const item = document.createElement('div');
                    item.className = 'shop-item';
                    item.innerHTML = `<div class="shop-name">${t.name}</div><canvas id="shop-tool-${id}" width="32" height="32"></canvas><div class="shop-price">$${t.price}</div>`;
                    item.onclick = () => {
                        if (coins >= t.price) {
                            coins -= t.price; addItemToInventory(parseInt(id), 1);
                            updateUI(); savePlayerData();
                        }
                    };
                    grid.appendChild(item);
                    drawItemIcon(document.getElementById(`shop-tool-${id}`), parseInt(id));
                });
            } else if (tab === 'skins') {
                Object.entries(SKINS).forEach(([id, s]) => {
                    const item = document.createElement('div');
                    item.className = 'shop-item';
                    item.innerHTML = `<div class="shop-name">${s.name}</div><div style="width:20px;height:20px;background:${id==='default'?'#ccc':`#${s.color.toString(16)}`}"></div><div class="shop-price">${s.price}</div>`;
                    item.onclick = () => {
                        if (currentSkin === id) return;
                        if (coins >= s.price) {
                            coins -= s.price; currentSkin = id;
                            loadPlayerModel(id); updateUI(); savePlayerData();
                        }
                    };
                    grid.appendChild(item);
                });
            }
        };

        function removeItemFromInventory(id, count) {
            for (let i = 0; i < 30; i++) {
                if (inventory[i] && inventory[i].id === id && inventory[i].count >= count) {
                    inventory[i].count -= count;
                    if (inventory[i].count <= 0) inventory[i] = null;
                    return true;
                }
            }
            return false;
        }

        function updateToolStats() {
            const item = inventory[activeHotbarIndex];
            if (item && TOOLS[item.id]) {
                activeTool = item.id;
                currentMineDelay = 400 * TOOLS[item.id].speedMod;
            } else {
                activeTool = null;
                currentMineDelay = 400;
            }
        }

        function loop() {
            if (!running || paused) return;
            const dt = 0.016;
            
            let moveX = (keys['KeyD']?1:0) - (keys['KeyA']?1:0) + joy.x;
            let moveZ = (keys['KeyS']?1:0) - (keys['KeyW']?1:0) + joy.y;
            
            const dir = new THREE.Vector3(moveX, 0, moveZ).normalize().applyQuaternion(playerGroup.quaternion);
            playerGroup.position.add(dir.multiplyScalar(5 * dt));
            
            if (keys['Space'] && onGround) { vel.y = 5; onGround = false; }
            vel.y -= 15 * dt;
            playerGroup.position.y += vel.y * dt;
            
            if (playerGroup.position.y < 14) { playerGroup.position.y = 14; vel.y = 0; onGround = true; }
            
            const cx = Math.floor(playerGroup.position.x / CHUNK_SIZE), cz = Math.floor(playerGroup.position.z / CHUNK_SIZE);
            for (let x = -RENDER_DIST; x <= RENDER_DIST; x++) {
                for (let z = -RENDER_DIST; z <= RENDER_DIST; z++) {
                    if (!chunkMeshes[`${cx+x},${cz+z}`]) buildChunk(cx+x, cz+z);
                }
            }
            
            if (mixer) mixer.update(dt);
            if (modelLoaded) {
                const isMoving = Math.abs(moveX) > 0.1 || Math.abs(moveZ) > 0.1;
                const targetAct = isMoving ? actions['Walking'] : actions['Idle'];
                if (activeAction !== targetAct) {
                    activeAction.fadeOut(0.2);
                    targetAct.reset().fadeIn(0.2).play();
                    activeAction = targetAct;
                }
            }

            raycaster.setFromCamera(new THREE.Vector2(0, 0), camera);
            const hits = raycaster.intersectObjects(Object.values(chunkMeshes));
            if (hits.length > 0 && hits[0].distance < 5) {
                const p = hits[0].point.clone().add(hits[0].face.normal.clone().multiplyScalar(-0.5));
                selectionBox.position.set(Math.floor(p.x)+0.5, Math.floor(p.y)+0.5, Math.floor(p.z)+0.5);
                selectionBox.visible = true;
            } else selectionBox.visible = false;

            updateToolStats();
            renderer.render(scene, camera);
            requestAnimationFrame(loop);
        }

        initScene();
    </script>
</body>
</html>

